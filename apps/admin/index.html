<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Carsales — Admin Console</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --surface:#ffffff;
      --surface2:#fbfbfd;

      --ink:#0f172a;
      --muted:#64748b;
      --muted2:#94a3b8;

      --brand:#dc2626;
      --brand2:#ef4444;
      --brandSoft:#fee2e2;
      --brandLine:rgba(220,38,38,.18);

      --line:#e5e7eb;
      --shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
      --shadow2: 0 10px 24px rgba(15, 23, 42, 0.08);

      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;

      --radius:18px;
      --radius2:24px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --sans: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(circle at top left, rgba(220,38,38,.08), transparent 45%),
        radial-gradient(circle at bottom right, rgba(239,68,68,.06), transparent 55%),
        var(--bg);
      -webkit-font-smoothing:antialiased;
    }
    a{color:inherit;text-decoration:none}
    .hidden{display:none!important}

    .wrap{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }

    .shell{
      width:100%;
      max-width:1260px;
      background:rgba(255,255,255,.86);
      border-radius:var(--radius2);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      padding:18px;
      backdrop-filter: blur(12px);
    }

    .top{
      display:flex;
      flex-wrap:wrap;
      gap:14px;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:14px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .badge{
      width:44px;height:44px;border-radius:16px;
      background: radial-gradient(circle at 20% 20%, #fff, var(--brandSoft) 55%, rgba(220,38,38,.25));
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:18px;color:var(--brand);
      box-shadow: 0 12px 24px rgba(220,38,38,.14);
    }
    .title{font-size:18px;font-weight:900}
    .sub{font-size:12px;color:var(--muted);margin-top:3px}

    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    .btn{
      border-radius:999px;
      border:1px solid transparent;
      padding:9px 14px;
      font-size:12px;
      font-weight:750;
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      background:transparent;
      color:var(--ink);
      transition:transform .12s ease, box-shadow .12s ease, background .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .btn-ghost{
      border:1px solid var(--line);
      background:rgba(255,255,255,.90);
      box-shadow:var(--shadow2);
    }
    .btn-ghost:hover{transform:translateY(-1px)}

    .btn-primary{
      background:linear-gradient(135deg, var(--brand2), var(--brand));
      color:#fff;
      box-shadow:0 16px 32px rgba(220,38,38,.28);
    }
    .btn-primary:hover{transform:translateY(-1px)}

    .btn-danger{
      border:1px solid rgba(239,68,68,.30);
      background:rgba(239,68,68,.08);
      color:#991b1b;
      box-shadow:var(--shadow2);
    }
    .btn-danger:hover{transform:translateY(-1px); background:rgba(239,68,68,.12)}

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.90);
      border:1px solid var(--line);
      font-size:12px;
      color:var(--muted);
      box-shadow:var(--shadow2);
    }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background:var(--warn);
      box-shadow:0 0 0 3px rgba(245,158,11,.18);
    }
    .dot.on{background:var(--ok); box-shadow:0 0 0 3px rgba(22,163,74,.18)}
    .dot.err{background:var(--bad); box-shadow:0 0 0 3px rgba(239,68,68,.18)}

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    @media(min-width:1020px){
      .grid{grid-template-columns:0.36fr 0.64fr}
    }

    .panel{
      background:rgba(255,255,255,.92);
      border:1px solid var(--line);
      border-radius:20px;
      padding:14px;
      box-shadow:var(--shadow2);
    }
    .panel h3{
      margin:0 0 6px;
      font-size:13px;
      font-weight:900;
      letter-spacing:.02em;
    }
    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }

    /* Inputs */
    .field{margin-top:10px}
    .label{
      display:flex;
      justify-content:space-between;
      gap:8px;
      font-size:11px;
      color:var(--muted);
      margin-bottom:5px;
    }
    .input,.select,.textarea{
      width:100%;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.92);
      padding:10px 12px;
      font-size:13px;
      color:var(--ink);
      outline:none;
      transition:box-shadow .12s ease, border-color .12s ease;
    }
    .input:focus,.select:focus,.textarea:focus{
      border-color:rgba(220,38,38,.45);
      box-shadow:0 0 0 4px rgba(220,38,38,.12);
    }
    .textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr;gap:8px}
    @media(min-width:560px){.row.two{grid-template-columns:1fr 1fr}}

    /* Tabs */
    .tabs{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      border-radius:999px;
      padding:4px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.92);
      box-shadow:var(--shadow2);
    }
    .tab{
      border:none;
      cursor:pointer;
      padding:7px 12px;
      border-radius:999px;
      background:transparent;
      color:var(--muted);
      font-size:11px;
      font-weight:900;
      letter-spacing:.05em;
      transition: background .12s ease, color .12s ease, transform .08s ease;
    }
    .tab.active{
      background:rgba(220,38,38,.10);
      color:var(--brand);
      transform:translateY(-1px);
    }

    /* Table */
    .table-shell{
      overflow:hidden;
      border-radius:20px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.96);
      box-shadow:var(--shadow2);
    }
    .table-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(to right, rgba(220,38,38,.05), rgba(255,255,255,.92));
    }
    .table-title{font-size:13px;font-weight:900}
    .table-meta{font-size:11px;color:var(--muted)}
    .scroll{max-height:610px;overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:12px}
    thead{position:sticky;top:0;background:var(--surface2);z-index:1}
    th,td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--line)}
    th{font-size:11px;text-transform:uppercase;letter-spacing:.06em;color:var(--muted)}
    tbody tr:hover{background:rgba(220,38,38,.04)}
    .mono{font-family:var(--mono); font-size:11px}

    .badgeMini{
      display:inline-flex;
      align-items:center;
      padding:3px 8px;
      border-radius:999px;
      font-size:10px;
      border:1px solid rgba(220,38,38,.22);
      background:rgba(220,38,38,.06);
      color:#991b1b;
    }

    .status{
      display:inline-flex;
      align-items:center;
      padding:3px 9px;
      border-radius:999px;
      font-size:10px;
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      border:1px solid transparent;
    }
    .available{background:rgba(22,163,74,.10);color:#166534;border-color:rgba(22,163,74,.30)}
    .pending{background:rgba(245,158,11,.12);color:#92400e;border-color:rgba(245,158,11,.35)}
    .sold{background:rgba(239,68,68,.12);color:#991b1b;border-color:rgba(239,68,68,.35)}

    .active{background:rgba(22,163,74,.10);color:#166534;border-color:rgba(22,163,74,.30)}
    .paused{background:rgba(245,158,11,.10);color:#92400e;border-color:rgba(245,158,11,.30)}

    .reqNew{background:rgba(239,68,68,.10);color:#991b1b;border-color:rgba(239,68,68,.25)}
    .reqBooked{background:rgba(22,163,74,.10);color:#166534;border-color:rgba(22,163,74,.25)}
    .reqClosed{background:rgba(15,23,42,.06);color:#0f172a;border-color:rgba(15,23,42,.10)}

    /* Modal */
    .backdrop{
      position:fixed;inset:0;z-index:50;
      background:rgba(15,23,42,.55);
      backdrop-filter:blur(10px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .backdrop.show{display:flex}
    .modal{
      width:100%;
      max-width:820px;
      background:rgba(255,255,255,.98);
      border-radius:26px;
      border:1px solid var(--line);
      box-shadow:0 30px 70px rgba(15,23,42,.22);
      overflow:hidden;
    }
    .mhead{
      padding:14px 16px 10px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(to right, rgba(220,38,38,.06), rgba(255,255,255,.94));
    }
    .mhead h3{margin:0;font-size:14px;font-weight:900}
    .xbtn{
      border:none;
      background:rgba(15,23,42,.04);
      color:var(--ink);
      font-size:20px;
      cursor:pointer;
      width:34px;height:34px;
      border-radius:999px;
    }
    .xbtn:hover{background:rgba(220,38,38,.10);color:var(--brand)}
    .mbody{padding:14px 16px}
    .statusline{min-height:18px;font-size:12px;color:var(--muted);margin-top:8px}
    .statusline.error{color:var(--bad)}

    /* Toast */
    #toast{
      position:fixed;
      bottom:16px;
      right:16px;
      z-index:60;
      padding:10px 14px;
      border-radius:999px;
      font-size:12px;
      display:none;
      align-items:center;
      gap:8px;
      background:rgba(255,255,255,.92);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
    }
    #toast.show{display:flex}
    #toast.success{border-color:rgba(22,163,74,.35);color:#166534}
    #toast.error{border-color:rgba(239,68,68,.35);color:#991b1b}
    #toastDot{width:8px;height:8px;border-radius:999px;background:var(--brand)}

    .splitBtns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin-top:12px}
  </style>
</head>

<body>
  <div class="wrap">

    <!-- LOGIN -->
    <div class="shell" id="loginView">
      <div class="top">
        <div class="brand">
          <div class="badge">A</div>
          <div>
            <div class="title">Admin Console</div>
            <div class="sub">Manage dealers, inventory, and viewing requests.</div>
          </div>
        </div>
        <div class="actions">
          <a class="btn btn-ghost" href="/">← Storefront</a>
          <a class="btn btn-ghost" href="/apps/dealer">Dealer ↗</a>
        </div>
      </div>

      <div class="panel">
        <h3>Sign in</h3>
        <div class="hint">
          Test credentials are controlled by <span class="mono">Cloud Run env vars</span>
          (<span class="mono">ADMIN_USERNAME</span> / <span class="mono">ADMIN_PASSWORD</span>).
        </div>

        <div class="row two" style="margin-top:10px">
          <div class="field">
            <div class="label"><span>Username</span><span>Required</span></div>
            <input id="username" class="input" placeholder="adminpytch" autocomplete="username" />
          </div>
          <div class="field">
            <div class="label"><span>Password</span><span>Required</span></div>
            <input id="password" class="input" type="password" placeholder="••••••••" autocomplete="current-password" />
          </div>
        </div>

        <div class="splitBtns">
          <button class="btn btn-ghost" id="btnDemo" type="button">Demo mode</button>
          <button class="btn btn-primary" id="btnLogin" type="button">Sign in</button>
        </div>

        <div class="statusline" id="loginStatus"></div>
      </div>
    </div>

    <!-- DASH -->
    <div class="shell hidden" id="dashView">
      <div class="top">
        <div class="brand">
          <div class="badge">A</div>
          <div>
            <div class="title">Carsales Admin</div>
            <div class="sub" id="whoami">Admin</div>
          </div>
        </div>

        <div class="actions">
          <div class="pill" title="API health">
            <span class="dot" id="apiDot"></span>
            <span id="apiStatus">Connecting…</span>
          </div>

          <div class="tabs" role="tablist" aria-label="Admin tabs">
            <button class="tab active" id="tabDealers" data-tab="dealers" type="button">Dealers</button>
            <button class="tab" id="tabInventory" data-tab="inventory" type="button">Inventory</button>
            <button class="tab" id="tabRequests" data-tab="requests" type="button">Requests</button>
            <button class="tab" id="tabSettings" data-tab="settings" type="button">Settings</button>
          </div>

          <button class="btn btn-ghost" id="btnRefresh" type="button">Refresh</button>
          <button class="btn btn-ghost" id="btnLogout" type="button">Logout</button>
        </div>
      </div>

      <div class="grid">
        <!-- LEFT CONTROL PANEL -->
        <div class="panel">
          <h3>Controls</h3>
          <div class="hint" id="hint">
            Search + filter across the current tab.
          </div>

          <div class="field">
            <div class="label"><span>Search</span><span>Dealer / Vehicle / Customer</span></div>
            <input id="q" class="input" placeholder="Search…" />
          </div>

          <div class="field" id="statusFilterWrap">
            <div class="label"><span>Status filter</span><span>Contextual</span></div>
            <select id="statusFilter" class="select">
              <option value="">All</option>
            </select>
          </div>

          <div class="statusline" id="dashStatus"></div>

          <!-- Contextual actions (Dealers tab) -->
          <div class="panel" id="dealerActions" style="margin-top:10px">
            <h3>Dealer actions</h3>
            <div class="hint">Create a dealer profile and generate a passcode.</div>

            <div class="field">
              <div class="label"><span>Dealer name</span><span>Required</span></div>
              <input id="newDealerName" class="input" placeholder="Pytch Motors" />
            </div>

            <div class="row two">
              <div class="field">
                <div class="label"><span>Dealer ID</span><span>Required</span></div>
                <input id="newDealerId" class="input" placeholder="dealerpytch" />
              </div>
              <div class="field">
                <div class="label"><span>Status</span><span>Default</span></div>
                <select id="newDealerStatus" class="select">
                  <option value="active">Active</option>
                  <option value="paused">Paused</option>
                </select>
              </div>
            </div>

            <div class="row two">
              <div class="field">
                <div class="label"><span>WhatsApp</span><span>Optional</span></div>
                <input id="newDealerWhatsApp" class="input" placeholder="8765550123" />
              </div>
              <div class="field">
                <div class="label"><span>Logo URL</span><span>Optional</span></div>
                <input id="newDealerLogo" class="input" placeholder="https://..." />
              </div>
            </div>

            <div class="splitBtns">
              <button class="btn btn-ghost" id="btnOpenDealerModal" type="button">Open dealer editor</button>
              <button class="btn btn-primary" id="btnCreateDealer" type="button">Create dealer</button>
            </div>

            <div class="statusline" id="dealerActionStatus"></div>
          </div>

          <!-- System Info -->
          <div class="panel" style="margin-top:10px">
            <h3>System</h3>
            <div class="hint">
              Media bucket: <span class="mono" id="bucketName">samplemedia1</span><br/>
              Upload path: <span class="mono">dealers/{dealerId}/vehicles/{vehicleId}/images/original/</span><br/>
              Leads path (server-side): <span class="mono">dealers/{dealerId}/leads/</span>
            </div>
          </div>
        </div>

        <!-- RIGHT TABLE -->
        <div class="table-shell">
          <div class="table-head">
            <div>
              <div class="table-title" id="tableTitle">Dealers</div>
              <div class="table-meta">Showing <span id="count">0</span> rows</div>
            </div>
            <div class="table-meta" id="lastUpdated">—</div>
          </div>

          <div class="scroll">
            <table>
              <thead>
                <tr id="theadRow"></tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- DEALER EDIT MODAL -->
  <div class="backdrop" id="dealerBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Dealer editor">
      <div class="mhead">
        <div>
          <h3 id="mTitle">Dealer editor</h3>
          <div class="sub" style="font-size:12px;color:var(--muted)" id="mSub">Edit dealer profile and reset passcode.</div>
        </div>
        <button class="xbtn" id="mClose" type="button" aria-label="Close">×</button>
      </div>

      <div class="mbody">
        <div class="row two">
          <div class="field">
            <div class="label"><span>Dealer name</span></div>
            <input id="mDealerName" class="input" />
          </div>
          <div class="field">
            <div class="label"><span>Dealer ID</span></div>
            <input id="mDealerId" class="input" />
          </div>
        </div>

        <div class="row two">
          <div class="field">
            <div class="label"><span>Status</span></div>
            <select id="mDealerStatus" class="select">
              <option value="active">Active</option>
              <option value="paused">Paused</option>
            </select>
          </div>
          <div class="field">
            <div class="label"><span>WhatsApp</span></div>
            <input id="mDealerWhatsApp" class="input" placeholder="8765550123" />
          </div>
        </div>

        <div class="field">
          <div class="label"><span>Logo URL</span></div>
          <input id="mDealerLogo" class="input" placeholder="https://..." />
        </div>

        <div class="panel" style="margin-top:10px">
          <h3>Security</h3>
          <div class="hint">Reset generates a fresh passcode for the dealer (server controls the real value).</div>

          <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-top:8px">
            <div class="pill" title="Current passcode (only shown in demo mode)" style="box-shadow:none">
              <span class="dot on" style="box-shadow:none"></span>
              <span>Passcode: <span class="mono" id="mPasscode">••••••</span></span>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <button class="btn btn-danger" id="btnResetPasscode" type="button">Reset passcode</button>
              <button class="btn btn-primary" id="btnSaveDealer" type="button">Save changes</button>
            </div>
          </div>

          <div class="statusline" id="mStatus"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast">
    <div id="toastDot"></div>
    <div id="toastMsg"></div>
  </div>

  <script>
    // =============================
    // API CONTRACT (expected)
    // =============================
    // POST /api/admin/login                  { username, password } -> { ok:true, token }
    // GET  /api/admin/dealers                (auth) -> { ok:true, dealers:[...] }
    // POST /api/admin/dealers                (auth) -> { ok:true, dealer, passcode? }
    // POST /api/admin/reset-passcode         (auth) -> { ok:true, dealerId, passcode }
    // GET  /api/admin/inventory              (auth) -> { ok:true, vehicles:[...] }
    // GET  /api/admin/requests               (auth) -> { ok:true, requests:[...] }
    //
    // This UI supports DEMO MODE if API isn't ready.

    const API = {
      login: () => "/api/admin/login",
      dealers: () => "/api/admin/dealers",
      resetPass: () => "/api/admin/reset-passcode",
      inventory: () => "/api/admin/inventory",
      requests: () => "/api/admin/requests",
    };

    const el = (id) => document.getElementById(id);

    const ui = {
      loginView: el("loginView"),
      dashView: el("dashView"),
      username: el("username"),
      password: el("password"),
      btnLogin: el("btnLogin"),
      btnDemo: el("btnDemo"),
      loginStatus: el("loginStatus"),

      whoami: el("whoami"),
      apiDot: el("apiDot"),
      apiStatus: el("apiStatus"),
      btnRefresh: el("btnRefresh"),
      btnLogout: el("btnLogout"),

      tabDealers: el("tabDealers"),
      tabInventory: el("tabInventory"),
      tabRequests: el("tabRequests"),
      tabSettings: el("tabSettings"),

      hint: el("hint"),

      q: el("q"),
      statusFilterWrap: el("statusFilterWrap"),
      statusFilter: el("statusFilter"),

      tableTitle: el("tableTitle"),
      theadRow: el("theadRow"),
      tbody: el("tbody"),
      count: el("count"),
      lastUpdated: el("lastUpdated"),
      dashStatus: el("dashStatus"),

      bucketName: el("bucketName"),

      dealerActions: el("dealerActions"),
      newDealerName: el("newDealerName"),
      newDealerId: el("newDealerId"),
      newDealerStatus: el("newDealerStatus"),
      newDealerWhatsApp: el("newDealerWhatsApp"),
      newDealerLogo: el("newDealerLogo"),
      btnCreateDealer: el("btnCreateDealer"),
      btnOpenDealerModal: el("btnOpenDealerModal"),
      dealerActionStatus: el("dealerActionStatus"),

      dealerBackdrop: el("dealerBackdrop"),
      mClose: el("mClose"),
      mTitle: el("mTitle"),
      mSub: el("mSub"),
      mDealerName: el("mDealerName"),
      mDealerId: el("mDealerId"),
      mDealerStatus: el("mDealerStatus"),
      mDealerWhatsApp: el("mDealerWhatsApp"),
      mDealerLogo: el("mDealerLogo"),
      mPasscode: el("mPasscode"),
      btnResetPasscode: el("btnResetPasscode"),
      btnSaveDealer: el("btnSaveDealer"),
      mStatus: el("mStatus"),

      toast: el("toast"),
      toastDot: el("toastDot"),
      toastMsg: el("toastMsg"),
    };

    const state = {
      tab: "dealers",
      token: null,
      apiOnline: false,

      dealers: [],
      vehicles: [],
      requests: [],

      selectedDealer: null,

      // demo-only passcodes
      demoPasscodes: {}
    };

    document.addEventListener("DOMContentLoaded", () => {
      wire();
      // nice for your test run
      ui.username.value = "adminpytch";
      ui.password.value = "123456";
    });

    function wire(){
      ui.btnLogin.addEventListener("click", doLogin);
      ui.btnDemo.addEventListener("click", enterDemo);
      ui.password.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });

      ui.btnLogout.addEventListener("click", logout);
      ui.btnRefresh.addEventListener("click", refresh);

      [ui.tabDealers, ui.tabInventory, ui.tabRequests, ui.tabSettings].forEach(btn=>{
        btn.addEventListener("click", ()=> setTab(btn.dataset.tab));
      });

      ui.q.addEventListener("keydown", (e)=>{ if(e.key==="Enter") render(); });
      ui.statusFilter.addEventListener("change", render);

      ui.btnCreateDealer.addEventListener("click", createDealer);
      ui.btnOpenDealerModal.addEventListener("click", () => {
        if(!state.dealers.length) return toast("No dealers yet. Create one first.", "error");
        openDealerModal(state.dealers[0]);
      });

      ui.mClose.addEventListener("click", closeDealerModal);
      ui.dealerBackdrop.addEventListener("click", (e)=>{ if(e.target === ui.dealerBackdrop) closeDealerModal(); });

      ui.btnResetPasscode.addEventListener("click", resetPasscode);
      ui.btnSaveDealer.addEventListener("click", saveDealerChanges);
    }

    async function doLogin(){
      const username = (ui.username.value||"").trim();
      const password = (ui.password.value||"").trim();
      if(!username || !password) return setLoginStatus("Enter username + password.", true);

      setLoginStatus("Signing in…", false);

      try{
        const res = await fetch(API.login(), {
          method:"POST",
          headers:{ "Content-Type":"application/json", "Accept":"application/json" },
          body: JSON.stringify({ username, password })
        });

        const data = await safeJson(res);
        if(!res.ok || !data?.ok) throw new Error(data?.error || "Login failed");

        state.apiOnline = true;
        state.token = data.token;
        setApi("Live", "on");
        enterDashboard(username);
      }catch(e){
        // if backend isn't ready, allow demo
        setApi("Demo", "err");
        setLoginStatus("API login not ready. Use Demo mode to continue UI build.", true);
      }
    }

    function enterDemo(){
      state.apiOnline = false;
      state.token = "demo-token";
      setApi("Demo", "warn");
      enterDashboard("adminpytch");
    }

    function enterDashboard(username){
      ui.loginView.classList.add("hidden");
      ui.dashView.classList.remove("hidden");
      ui.whoami.textContent = `Admin · ${username}`;
      seedDemoIfNeeded();
      setTab("dealers");
      refresh();
      toast("Signed in.", "success");
    }

    function logout(){
      state.token = null;
      state.apiOnline = false;
      state.dealers = [];
      state.vehicles = [];
      state.requests = [];
      state.selectedDealer = null;

      ui.dashView.classList.add("hidden");
      ui.loginView.classList.remove("hidden");
      ui.loginStatus.textContent = "";
      toast("Logged out.", "success");
    }

    async function refresh(){
      ui.dashStatus.textContent = state.apiOnline ? "Loading from API…" : "Loading demo data…";
      ui.lastUpdated.textContent = "Updated: " + fmt(new Date());

      if(!state.apiOnline){
        ui.dashStatus.textContent = "Ready (demo).";
        render();
        return;
      }

      try{
        if(state.tab === "dealers" || state.tab === "settings"){
          const res = await fetch(API.dealers(), { headers: authHeaders() });
          const data = await safeJson(res);
          if(!res.ok || !data?.ok) throw new Error(data?.error || "Failed to load dealers");
          state.dealers = Array.isArray(data.dealers) ? data.dealers : [];
        }
        if(state.tab === "inventory"){
          const res = await fetch(API.inventory(), { headers: authHeaders() });
          const data = await safeJson(res);
          if(!res.ok || !data?.ok) throw new Error(data?.error || "Failed to load inventory");
          state.vehicles = Array.isArray(data.vehicles) ? data.vehicles : [];
        }
        if(state.tab === "requests"){
          const res = await fetch(API.requests(), { headers: authHeaders() });
          const data = await safeJson(res);
          if(!res.ok || !data?.ok) throw new Error(data?.error || "Failed to load requests");
          state.requests = Array.isArray(data.requests) ? data.requests : [];
        }

        ui.dashStatus.textContent = "Ready.";
        setApi("Live", "on");
        render();
      }catch(e){
        ui.dashStatus.textContent = "Could not load from API.";
        setApi("Error", "err");
        toast("API error: " + (e?.message||"failed"), "error");
      }
    }

    function setTab(tab){
      state.tab = tab;

      ui.tabDealers.classList.toggle("active", tab==="dealers");
      ui.tabInventory.classList.toggle("active", tab==="inventory");
      ui.tabRequests.classList.toggle("active", tab==="requests");
      ui.tabSettings.classList.toggle("active", tab==="settings");

      ui.tableTitle.textContent =
        tab==="dealers" ? "Dealers"
        : tab==="inventory" ? "Inventory"
        : tab==="requests" ? "Viewing requests"
        : "Platform settings";

      ui.hint.textContent =
        tab==="dealers" ? "Create and manage dealer accounts. Reset passcodes. Set WhatsApp + branding."
        : tab==="inventory" ? "Search across all dealers. Verify status and listing quality."
        : tab==="requests" ? "Monitor incoming leads. Promote from New → Booked → Closed."
        : "Review environment-driven settings and shortcuts.";

      // show dealer actions only on dealer tab
      ui.dealerActions.classList.toggle("hidden", tab!=="dealers");

      buildStatusFilterOptions(tab);
      buildTableHeaders(tab);

      // when switching tabs, optionally load that tab from API
      refresh();
    }

    function buildStatusFilterOptions(tab){
      ui.statusFilter.innerHTML = "";
      const add = (v, t) => {
        const o = document.createElement("option");
        o.value = v; o.textContent = t;
        ui.statusFilter.appendChild(o);
      };

      add("", "All");

      if(tab === "dealers"){
        add("active", "Active");
        add("paused", "Paused");
      } else if(tab === "inventory"){
        add("available", "Available");
        add("pending", "Pending");
        add("sold", "Sold");
      } else if(tab === "requests"){
        add("new", "New");
        add("booked", "Booked");
        add("closed", "Closed");
      } else {
        // settings tab
        add("", "All");
      }

      ui.statusFilterWrap.classList.toggle("hidden", tab==="settings");
    }

    function buildTableHeaders(tab){
      ui.theadRow.innerHTML = "";

      const cols =
        tab==="dealers" ? ["Dealer", "Dealer ID", "Status", "WhatsApp", "Vehicles"]
        : tab==="inventory" ? ["Vehicle", "Dealer", "Status", "Price", "Updated"]
        : tab==="requests" ? ["Customer", "Vehicle", "Dealer", "Status", "Requested"]
        : ["Item", "Value", "Hint", "Scope", "Action"];

      cols.forEach(c=>{
        const th = document.createElement("th");
        th.textContent = c;
        ui.theadRow.appendChild(th);
      });
    }

    function render(){
      const q = (ui.q.value||"").trim().toLowerCase();
      const f = (ui.statusFilter.value||"").trim().toLowerCase();

      let rows = [];
      if(state.tab==="dealers") rows = [...state.dealers];
      if(state.tab==="inventory") rows = [...state.vehicles];
      if(state.tab==="requests") rows = [...state.requests];
      if(state.tab==="settings") rows = settingsRows();

      if(q){
        rows = rows.filter(r => JSON.stringify(r).toLowerCase().includes(q));
      }
      if(f && state.tab!=="settings"){
        rows = rows.filter(r => (r.status||"").toLowerCase() === f);
      }

      ui.tbody.innerHTML = "";
      ui.count.textContent = String(rows.length);

      if(!rows.length){
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5;
        td.style.color = "var(--muted)";
        td.style.padding = "14px";
        td.textContent = "No rows match your filters.";
        tr.appendChild(td);
        ui.tbody.appendChild(tr);
        return;
      }

      rows.forEach(r=>{
        const tr = document.createElement("tr");

        if(state.tab==="dealers"){
          tr.style.cursor = "pointer";
          tr.addEventListener("click", ()=> openDealerModal(r));

          tr.appendChild(cell(`<div style="font-weight:900">${esc(r.name||"—")}</div><div style="color:var(--muted);font-size:11px;margin-top:2px">Branding + WhatsApp controls</div>`));
          tr.appendChild(cell(`<span class="mono">${esc(r.dealerId||"—")}</span>`));
          tr.appendChild(cell(dealerStatusPill(r.status)));
          tr.appendChild(cell(r.whatsapp ? `<span class="badgeMini">+${esc(r.whatsapp)}</span>` : `<span style="color:var(--muted)">—</span>`));
          tr.appendChild(cell(`<span class="badgeMini">${Number(r.vehicleCount||0)} vehicles</span>`));
        }

        if(state.tab==="inventory"){
          tr.appendChild(cell(`<div class="mono">${esc(r.vehicleId||r.id||"—")}</div><div style="color:var(--muted);font-size:11px;margin-top:2px">${esc(r.make||"")} ${esc(r.model||"")}</div>`));
          tr.appendChild(cell(`<span class="badgeMini">${esc(r.dealerId||"—")}</span>`));
          tr.appendChild(cell(invStatusPill(r.status)));
          tr.appendChild(cell(`<div style="font-weight:900">${money(r.price)}</div>`));
          tr.appendChild(cell(`<span class="mono">${esc(r.updated||r.updatedAt||r.createdAt||"—")}</span>`));
        }

        if(state.tab==="requests"){
          tr.appendChild(cell(`<div style="font-weight:900">${esc(r.customer||r.name||"—")}</div><div style="color:var(--muted);font-size:11px;margin-top:2px">${esc(r.phone||"")}</div>`));
          tr.appendChild(cell(`<div class="mono">${esc(r.vehicleId||"—")}</div>`));
          tr.appendChild(cell(`<span class="badgeMini">${esc(r.dealerId||"—")}</span>`));
          tr.appendChild(cell(reqPill(r.status)));
          tr.appendChild(cell(`<span class="mono">${esc(r.requested||r.createdAt||"—")}</span>`));
        }

        if(state.tab==="settings"){
          tr.appendChild(cell(`<div style="font-weight:900">${esc(r.item)}</div>`));
          tr.appendChild(cell(`<span class="mono">${esc(r.value)}</span>`));
          tr.appendChild(cell(`<span style="color:var(--muted)">${esc(r.hint)}</span>`));
          tr.appendChild(cell(`<span class="badgeMini">${esc(r.scope)}</span>`));
          tr.appendChild(cell(r.actionHtml || `<span style="color:var(--muted)">—</span>`));
        }

        ui.tbody.appendChild(tr);
      });
    }

    function settingsRows(){
      // UI-only view. Real values come from Cloud Run env vars + server response later.
      return [
        { item:"MEDIA_BUCKET", value:"samplemedia1", hint:"Where images/videos are stored", scope:"Cloud Run env", actionHtml:`<button class="btn btn-ghost" type="button" onclick="toast('Set in Cloud Run env vars.', 'success')">How to change</button>` },
        { item:"ADMIN_USERNAME", value:"(server)", hint:"Admin login username", scope:"Cloud Run env", actionHtml:`<button class="btn btn-ghost" type="button" onclick="toast('Change ADMIN_USERNAME in Cloud Run.', 'success')">How to change</button>` },
        { item:"ADMIN_PASSWORD", value:"(server)", hint:"Admin login password", scope:"Cloud Run env", actionHtml:`<button class="btn btn-ghost" type="button" onclick="toast('Change ADMIN_PASSWORD in Cloud Run.', 'success')">How to change</button>` },
        { item:"JWT_SECRET", value:"(server)", hint:"Signs login tokens", scope:"Cloud Run env", actionHtml:`<button class="btn btn-ghost" type="button" onclick="toast('Keep JWT_SECRET long + private.', 'success')">Best practice</button>` },
        { item:"GOOGLE_SHEET_ID", value:"(server)", hint:"Main spreadsheet for dealer tabs", scope:"Cloud Run env", actionHtml:`<button class="btn btn-ghost" type="button" onclick="toast('Set GOOGLE_SHEET_ID in Cloud Run.', 'success')">How to change</button>` },
      ];
    }

    // =============================
    // Dealer Modal
    // =============================
    function openDealerModal(dealer){
      state.selectedDealer = { ...dealer };
      ui.mTitle.textContent = "Dealer editor";
      ui.mSub.textContent = "Edit dealer profile and reset passcode.";
      ui.mStatus.textContent = "";

      ui.mDealerName.value = dealer.name || "";
      ui.mDealerId.value = dealer.dealerId || "";
      ui.mDealerStatus.value = (dealer.status || "active").toLowerCase();
      ui.mDealerWhatsApp.value = dealer.whatsapp || "";
      ui.mDealerLogo.value = dealer.logoUrl || dealer.logo || "";

      // demo-only: show passcode if we have it
      const demoPass = state.demoPasscodes[dealer.dealerId];
      ui.mPasscode.textContent = demoPass ? demoPass : "••••••";

      ui.dealerBackdrop.classList.add("show");
      ui.dealerBackdrop.setAttribute("aria-hidden","false");
    }

    function closeDealerModal(){
      ui.dealerBackdrop.classList.remove("show");
      ui.dealerBackdrop.setAttribute("aria-hidden","true");
      state.selectedDealer = null;
    }

    async function saveDealerChanges(){
      if(!state.selectedDealer) return;

      const payload = {
        dealerId: (ui.mDealerId.value||"").trim(),
        name: (ui.mDealerName.value||"").trim(),
        status: (ui.mDealerStatus.value||"active").toLowerCase(),
        whatsapp: digits(ui.mDealerWhatsApp.value||""),
        logoUrl: (ui.mDealerLogo.value||"").trim(),
      };

      if(!payload.dealerId || !payload.name){
        ui.mStatus.textContent = "Dealer ID and name are required.";
        ui.mStatus.classList.add("error");
        return;
      }

      ui.mStatus.textContent = "Saving…";
      ui.mStatus.classList.remove("error");

      try{
        if(!state.apiOnline){
          // demo update
          const idx = state.dealers.findIndex(d => d.dealerId === state.selectedDealer.dealerId);
          if(idx>-1){
            state.dealers[idx] = { ...state.dealers[idx], ...payload };
          }
          ui.mStatus.textContent = "Saved (demo).";
          toast("Dealer updated.", "success");
          render();
          return;
        }

        // For API, simplest approach is POST /api/admin/dealers for upsert
        const res = await fetch(API.dealers(), {
          method:"POST",
          headers:{ ...authHeaders(), "Content-Type":"application/json", "Accept":"application/json" },
          body: JSON.stringify({ ...payload, op:"upsert" })
        });
        const data = await safeJson(res);
        if(!res.ok || !data?.ok) throw new Error(data?.error || "Save failed");

        ui.mStatus.textContent = "Saved.";
        toast("Dealer updated.", "success");
        await refresh();
      }catch(e){
        ui.mStatus.textContent = "Failed to save.";
        ui.mStatus.classList.add("error");
        toast("Save failed: " + (e?.message||"error"), "error");
      }
    }

    async function resetPasscode(){
      if(!state.selectedDealer) return;

      ui.mStatus.textContent = "Resetting passcode…";
      ui.mStatus.classList.remove("error");

      const dealerId = (ui.mDealerId.value||"").trim();

      try{
        if(!state.apiOnline){
          // demo reset
          const newPass = String(Math.floor(100000 + Math.random()*900000));
          state.demoPasscodes[dealerId] = newPass;
          ui.mPasscode.textContent = newPass;
          ui.mStatus.textContent = "Passcode reset (demo).";
          toast("Passcode reset.", "success");
          return;
        }

        const res = await fetch(API.resetPass(), {
          method:"POST",
          headers:{ ...authHeaders(), "Content-Type":"application/json", "Accept":"application/json" },
          body: JSON.stringify({ dealerId })
        });
        const data = await safeJson(res);
        if(!res.ok || !data?.ok) throw new Error(data?.error || "Reset failed");

        // If backend returns passcode, we show it (admin only)
        if(data.passcode) ui.mPasscode.textContent = String(data.passcode);

        ui.mStatus.textContent = "Passcode reset.";
        toast("Passcode reset.", "success");
        await refresh();
      }catch(e){
        ui.mStatus.textContent = "Failed to reset passcode.";
        ui.mStatus.classList.add("error");
        toast("Reset failed: " + (e?.message||"error"), "error");
      }
    }

    // =============================
    // Dealer creation
    // =============================
    async function createDealer(){
      const payload = {
        name: (ui.newDealerName.value||"").trim(),
        dealerId: (ui.newDealerId.value||"").trim(),
        status: (ui.newDealerStatus.value||"active").toLowerCase(),
        whatsapp: digits(ui.newDealerWhatsApp.value||""),
        logoUrl: (ui.newDealerLogo.value||"").trim(),
      };

      if(!payload.name || !payload.dealerId){
        ui.dealerActionStatus.textContent = "Dealer name and ID are required.";
        ui.dealerActionStatus.classList.add("error");
        return;
      }

      ui.dealerActionStatus.textContent = "Creating…";
      ui.dealerActionStatus.classList.remove("error");

      try{
        if(!state.apiOnline){
          // demo add
          const exists = state.dealers.some(d => d.dealerId === payload.dealerId);
          if(exists) throw new Error("Dealer ID already exists (demo).");

          const pass = String(Math.floor(100000 + Math.random()*900000));
          state.demoPasscodes[payload.dealerId] = pass;

          state.dealers.unshift({
            name: payload.name,
            dealerId: payload.dealerId,
            status: payload.status,
            whatsapp: payload.whatsapp,
            logoUrl: payload.logoUrl,
            vehicleCount: 0
          });

          ui.dealerActionStatus.textContent = `Created (demo). Passcode: ${pass}`;
          toast("Dealer created.", "success");
          clearCreateInputs();
          render();
          return;
        }

        const res = await fetch(API.dealers(), {
          method:"POST",
          headers:{ ...authHeaders(), "Content-Type":"application/json", "Accept":"application/json" },
          body: JSON.stringify(payload)
        });
        const data = await safeJson(res);
        if(!res.ok || !data?.ok) throw new Error(data?.error || "Create failed");

        // If backend returns passcode, show it for admin to copy once.
        if(data.passcode){
          ui.dealerActionStatus.textContent = `Created. New passcode: ${data.passcode}`;
        } else {
          ui.dealerActionStatus.textContent = "Created.";
        }

        toast("Dealer created.", "success");
        clearCreateInputs();
        await refresh();
      }catch(e){
        ui.dealerActionStatus.textContent = "Failed to create dealer.";
        ui.dealerActionStatus.classList.add("error");
        toast("Create failed: " + (e?.message||"error"), "error");
      }
    }

    function clearCreateInputs(){
      ui.newDealerName.value = "";
      ui.newDealerId.value = "";
      ui.newDealerWhatsApp.value = "";
      ui.newDealerLogo.value = "";
      ui.newDealerStatus.value = "active";
    }

    // =============================
    // Demo seed data
    // =============================
    function seedDemoIfNeeded(){
      ui.bucketName.textContent = "samplemedia1";

      if(state.dealers.length) return;

      state.dealers = [
        { name:"Pytch Motors", dealerId:"dealerpytch", status:"active", whatsapp:"8765550123", logoUrl:"", vehicleCount:12 },
        { name:"Island Auto", dealerId:"DEALER-0002", status:"active", whatsapp:"8765550199", logoUrl:"", vehicleCount:7 },
        { name:"Mobay Cars", dealerId:"DEALER-0003", status:"paused", whatsapp:"", logoUrl:"", vehicleCount:3 },
      ];

      state.demoPasscodes["dealerpytch"] = "123456";

      state.vehicles = [
        { vehicleId:"VEH-10021", dealerId:"dealerpytch", make:"Toyota", model:"Vitz", status:"available", price:1250000, updated: fmt(new Date(Date.now()-3600*1000*8)) },
        { vehicleId:"VEH-10022", dealerId:"dealerpytch", make:"Honda", model:"Civic", status:"pending", price:2200000, updated: fmt(new Date(Date.now()-3600*1000*19)) },
        { vehicleId:"VEH-10031", dealerId:"DEALER-0002", make:"Nissan", model:"Note", status:"available", price:1450000, updated: fmt(new Date(Date.now()-3600*1000*5)) },
        { vehicleId:"VEH-10041", dealerId:"DEALER-0003", make:"BMW", model:"3 Series", status:"sold", price:3950000, updated: fmt(new Date(Date.now()-3600*1000*66)) },
      ];

      state.requests = [
        { customer:"Andre W.", phone:"876-555-0192", vehicleId:"VEH-10022", dealerId:"dealerpytch", status:"new", requested: fmt(new Date(Date.now()-3600*1000*2)) },
        { customer:"Kiera M.", phone:"876-555-0113", vehicleId:"VEH-10021", dealerId:"dealerpytch", status:"booked", requested: fmt(new Date(Date.now()-3600*1000*10)) },
        { customer:"Damien R.", phone:"876-555-0177", vehicleId:"VEH-10031", dealerId:"DEALER-0002", status:"closed", requested: fmt(new Date(Date.now()-3600*1000*30)) },
      ];
    }

    // =============================
    // UI helpers
    // =============================
    function cell(html){
      const td = document.createElement("td");
      td.innerHTML = html;
      return td;
    }

    function dealerStatusPill(s){
      const v = (s||"active").toLowerCase();
      const cls = v==="paused" ? "paused" : "active";
      return `<span class="status ${cls}">${esc(v)}</span>`;
    }
    function invStatusPill(s){
      const v = (s||"available").toLowerCase();
      const cls = v==="available" ? "available" : v==="pending" ? "pending" : "sold";
      return `<span class="status ${cls}">${esc(v)}</span>`;
    }
    function reqPill(s){
      const v = (s||"new").toLowerCase();
      const cls = v==="new" ? "reqNew" : v==="booked" ? "reqBooked" : "reqClosed";
      return `<span class="status ${cls}">${esc(v)}</span>`;
    }

    function setApi(text, mode){
      ui.apiStatus.textContent = text || "—";
      ui.apiDot.classList.remove("on","err");
      // default warn dot already present
      if(mode==="on") ui.apiDot.classList.add("on");
      if(mode==="err") ui.apiDot.classList.add("err");
    }

    function setLoginStatus(msg, err){
      ui.loginStatus.textContent = msg || "";
      ui.loginStatus.classList.toggle("error", !!err);
    }

    function toast(message, type){
      ui.toastMsg.textContent = message || "";
      ui.toast.classList.remove("success","error");
      if(type==="success"){ ui.toast.classList.add("success"); ui.toastDot.style.background="#22c55e"; }
      else if(type==="error"){ ui.toast.classList.add("error"); ui.toastDot.style.background="#ef4444"; }
      else ui.toastDot.style.background="var(--brand)";
      ui.toast.classList.add("show");
      clearTimeout(window.__t);
      window.__t = setTimeout(()=>ui.toast.classList.remove("show"), 3200);
    }

    function authHeaders(){
      return {
        "Accept":"application/json",
        "Authorization":"Bearer " + state.token
      };
    }

    async function safeJson(res){
      try{ return await res.json(); }catch(_){ return null; }
    }

    function money(n){
      const v = Number(n);
      if(!Number.isFinite(v) || v<=0) return "—";
      return "JMD " + v.toLocaleString(undefined,{maximumFractionDigits:0});
    }

    function fmt(d){
      const dt = (d instanceof Date)?d:new Date(d);
      const day = String(dt.getDate()).padStart(2,"0");
      const mon = String(dt.getMonth()+1).padStart(2,"0");
      const yr = String(dt.getFullYear()).slice(-2);
      const hr = String(dt.getHours()).padStart(2,"0");
      const mi = String(dt.getMinutes()).padStart(2,"0");
      return `${day}/${mon}/${yr} ${hr}:${mi}`;
    }

    function digits(s){
      // keep only digits for whatsapp
      return String(s||"").replace(/\D+/g,"").trim();
    }

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }
  </script>
</body>
</html>
