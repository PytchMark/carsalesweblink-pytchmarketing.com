<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Carsales – Dealer</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#0f1630;
      --card2:#121b3a;
      --ink:#eef2ff;
      --muted:#aab3d6;
      --muted2:#7f88ad;
      --border:rgba(255,255,255,.10);
      --shadow:0 18px 50px rgba(0,0,0,.45);
      --brand:#ff3b3b;
      --brand2:#ff6b6b;
      --good:#22c55e;
      --warn:#fbbf24;
      --bad:#fb7185;
      --radius:18px;
      --sans: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(1200px 800px at 15% 0%, rgba(255,59,59,.22), transparent 55%),
        radial-gradient(900px 650px at 85% 20%, rgba(80,120,255,.18), transparent 50%),
        linear-gradient(180deg, #060914, #070a18 30%, #050615);
      -webkit-font-smoothing:antialiased;
    }
    a{color:inherit;text-decoration:none}
    .hidden{display:none!important}

    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}
    .shell{
      width:100%;
      max-width:1180px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius:28px;
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(14px);
    }

    .top{
      display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;
      padding:16px 18px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: linear-gradient(90deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:44px;height:44px;border-radius:14px;
      display:grid;place-items:center;
      background: radial-gradient(circle at 30% 20%, #ffd6d6, var(--brand) 45%, #7f1d1d 100%);
      box-shadow:0 18px 30px rgba(255,59,59,.25);
      font-weight:900;
    }
    .title{font-weight:850;letter-spacing:.02em}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      color:var(--muted);
      font-size:12px;
    }
    .dot{width:9px;height:9px;border-radius:99px;background:var(--warn);box-shadow:0 0 0 4px rgba(251,191,36,.20)}
    .dot.on{background:var(--good);box-shadow:0 0 0 4px rgba(34,197,94,.22)}
    .dot.err{background:var(--bad);box-shadow:0 0 0 4px rgba(251,113,133,.20)}

    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--ink);
      border-radius:999px;
      padding:10px 14px;
      font-weight:750;
      font-size:12px;
      cursor:pointer;
      display:inline-flex;align-items:center;gap:8px;
      transition:transform .10s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.09);border-color:rgba(255,255,255,.18)}
    .btn:disabled{opacity:.55;cursor:not-allowed;transform:none}
    .btn-primary{
      border-color:rgba(0,0,0,.35);
      background: radial-gradient(circle at 20% 0%, var(--brand2), var(--brand) 55%, #b91c1c 100%);
      box-shadow:0 18px 36px rgba(255,59,59,.22);
    }

    .content{padding:18px}
    .grid{display:grid;grid-template-columns: 1fr;gap:14px}
    @media(min-width:980px){.grid{grid-template-columns: .42fr .58fr}}

    .card{
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      border-radius:22px;
      padding:14px;
      box-shadow: 0 14px 28px rgba(0,0,0,.25);
    }
    .card h3{margin:0 0 6px;font-size:13px;font-weight:900;letter-spacing:.03em}
    .hint{color:var(--muted);font-size:12px;line-height:1.35}
    .statusline{min-height:18px;margin-top:8px;color:var(--muted);font-size:12px}
    .statusline.error{color:var(--bad)}
    .mono{font-family:var(--mono)}

    .field{margin-top:10px}
    .label{display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:11px;margin-bottom:6px}
    .input,.select,.textarea{
      width:100%;
      background: rgba(15,22,48,.62);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:11px 12px;
      color:var(--ink);
      outline:none;
      font-size:13px;
      transition:border-color .15s ease, transform .08s ease, background .15s ease;
    }
    .input:focus,.select:focus,.textarea:focus{
      border-color: rgba(255,59,59,.55);
      background: rgba(15,22,48,.85);
      transform: translateY(-1px);
    }
    .textarea{min-height:96px;resize:vertical}

    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:560px){.row.two{grid-template-columns:1fr 1fr}}
    @media(min-width:820px){.row.three{grid-template-columns:1fr 1fr 1fr}}

    .table{
      overflow:hidden;border-radius:22px;border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
    }
    .thead{
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: linear-gradient(90deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    }
    .thead .t{font-weight:900;font-size:13px}
    .thead .m{color:var(--muted);font-size:12px}
    .scroll{max-height:560px;overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left}
    th{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    tbody tr{cursor:pointer}
    tbody tr:hover{background:rgba(255,255,255,.04)}
    .tag{
      display:inline-flex;align-items:center;
      padding:4px 10px;border-radius:999px;
      font-size:10px;font-weight:900;letter-spacing:.08em;text-transform:uppercase;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: var(--muted);
    }
    .tag.available{border-color:rgba(34,197,94,.45);color:#bbf7d0;background:rgba(34,197,94,.12)}
    .tag.pending{border-color:rgba(251,191,36,.45);color:#fde68a;background:rgba(251,191,36,.12)}
    .tag.sold{border-color:rgba(251,113,133,.45);color:#fecaca;background:rgba(251,113,133,.12)}

    /* Modal */
    .backdrop{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(10px);
      padding:16px;
      z-index:60;
    }
    .backdrop.show{display:flex}
    .modal{
      width:100%;
      max-width:980px;
      border-radius:26px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.20));
      box-shadow: 0 28px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .mhead{
      padding:14px 16px;
      display:flex;justify-content:space-between;align-items:flex-start;gap:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: linear-gradient(90deg, rgba(255,59,59,.12), rgba(255,255,255,.02));
    }
    .mhead h3{margin:0;font-size:14px;font-weight:950}
    .xbtn{
      width:36px;height:36px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--ink);
      cursor:pointer;
      font-size:18px;
    }
    .xbtn:hover{background:rgba(255,255,255,.10)}
    .mbody{padding:16px}
    .footerBtns{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;margin-top:12px}

    /* Toast */
    #toast{
      position:fixed;right:16px;bottom:16px;z-index:80;
      display:none;align-items:center;gap:10px;
      padding:10px 14px;border-radius:999px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      color:var(--muted);
      box-shadow: 0 18px 40px rgba(0,0,0,.55);
    }
    #toast.show{display:flex}
    #toastDot{width:10px;height:10px;border-radius:99px;background:var(--brand)}
    #toast.success{border-color:rgba(34,197,94,.38);color:#bbf7d0}
    #toast.error{border-color:rgba(251,113,133,.40);color:#fecaca}
  </style>
</head>

<body>
<div class="wrap">
  <div class="shell">

    <div class="top">
      <div class="brand">
        <div class="logo">D</div>
        <div>
          <div class="title" id="topTitle">Dealer Portal</div>
          <div class="sub" id="topSub">Log in to manage inventory + photos.</div>
        </div>
      </div>
      <div class="actions">
        <div class="pill">
          <span class="dot" id="apiDot"></span>
          <span id="apiText">Offline</span>
        </div>
        <a class="btn" href="/">Storefront ↗</a>
        <button class="btn" id="btnLogout" type="button">Logout ⎋</button>
      </div>
    </div>

    <div class="content">
      <!-- LOGIN -->
      <div class="grid" id="loginView">
        <div class="card">
          <h3>Sign in</h3>
          <div class="hint">Use the Dealer ID + passcode created in Admin.</div>

          <div class="row two" style="margin-top:10px">
            <div class="field">
              <div class="label"><span>Dealer ID</span><span>Required</span></div>
              <input class="input" id="dealerId" placeholder="DEALER-0001" autocomplete="username">
            </div>
            <div class="field">
              <div class="label"><span>Passcode</span><span>Required</span></div>
              <input class="input" id="passcode" type="password" placeholder="123456" autocomplete="current-password">
            </div>
          </div>

          <div class="footerBtns">
            <button class="btn" id="btnDemo" type="button">Demo ★</button>
            <button class="btn btn-primary" id="btnLogin" type="button">Sign in →</button>
          </div>

          <div class="statusline" id="loginStatus"></div>
        </div>

        <div class="card">
          <h3>Photo storage</h3>
          <div class="hint">
            Photos upload to <b>Cloudinary</b>. We first request a <span class="mono">signed upload</span> from your server
            (recommended), upload files, then save each <span class="mono">secure_url</span> into Google Sheets for the storefront.<br>
            <span style="opacity:.85">If the signed endpoint isn’t set up yet, this UI can automatically fall back to unsigned preset uploads.</span>
          </div>
          <div class="statusline" id="cfgLine"></div>
        </div>
      </div>

      <!-- DASH -->
      <div class="grid hidden" id="dashView">
        <div class="card">
          <h3>Controls</h3>
          <div class="hint">Search / filter your inventory.</div>

          <div class="field">
            <div class="label"><span>Search</span><span>Vehicle / Make / Model</span></div>
            <input class="input" id="q" placeholder="Search…">
          </div>

          <div class="row two">
            <div class="field">
              <div class="label"><span>Status</span><span>Filter</span></div>
              <select class="select" id="filterStatus">
                <option value="">All</option>
                <option value="available">Available</option>
                <option value="pending">Pending</option>
                <option value="sold">Sold</option>
              </select>
            </div>
            <div class="field">
              <div class="label"><span>Sort</span><span>Default</span></div>
              <select class="select" id="sort">
                <option value="newest">Newest</option>
                <option value="priceAsc">Price: Low → High</option>
                <option value="priceDesc">Price: High → Low</option>
                <option value="yearDesc">Year: New → Old</option>
                <option value="yearAsc">Year: Old → New</option>
              </select>
            </div>
          </div>

          <div class="footerBtns">
            <button class="btn" id="btnRefresh" type="button">Refresh ⟳</button>
            <button class="btn btn-primary" id="btnAdd" type="button">Add vehicle ＋</button>
          </div>

          <div class="statusline" id="dashStatus"></div>
        </div>

        <div class="table">
          <div class="thead">
            <div>
              <div class="t">Your vehicles</div>
              <div class="m">Showing <span id="count">0</span> vehicles</div>
            </div>
            <div class="m" id="lastUpdated">—</div>
          </div>

          <div class="scroll">
            <table>
              <thead>
                <tr>
                  <th>Vehicle</th>
                  <th>Specs</th>
                  <th>Status</th>
                  <th>Price</th>
                  <th>Photos</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- MODAL -->
<div class="backdrop" id="backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Vehicle editor">
    <div class="mhead">
      <div>
        <h3 id="mTitle">Add vehicle</h3>
        <div class="sub" id="mSub">Save to Sheets + upload photos to Cloudinary.</div>
      </div>
      <button class="xbtn" id="mClose" type="button" aria-label="Close">×</button>
    </div>

    <div class="mbody">
      <div class="row two">
        <div class="field">
          <div class="label"><span>Vehicle ID</span><span>Auto if empty</span></div>
          <input class="input mono" id="vId" placeholder="VEH-12345">
        </div>
        <div class="field">
          <div class="label"><span>Status</span><span>Required</span></div>
          <select class="select" id="vStatus">
            <option value="available">Available</option>
            <option value="pending">Pending</option>
            <option value="sold">Sold</option>
          </select>
        </div>
      </div>

      <div class="row two">
        <div class="field">
          <div class="label"><span>Make</span><span>Required</span></div>
          <input class="input" id="vMake" placeholder="Honda">
        </div>
        <div class="field">
          <div class="label"><span>Model</span><span>Required</span></div>
          <input class="input" id="vModel" placeholder="Civic">
        </div>
      </div>

      <div class="row three">
        <div class="field">
          <div class="label"><span>Year</span><span>Optional</span></div>
          <input class="input" id="vYear" type="number" placeholder="2018">
        </div>
        <div class="field">
          <div class="label"><span>Price (JMD)</span><span>Optional</span></div>
          <input class="input" id="vPrice" type="number" placeholder="1250000">
        </div>
        <div class="field">
          <div class="label"><span>Title</span><span>Optional</span></div>
          <input class="input" id="vTitle" placeholder="2018 Honda Civic — Clean unit">
        </div>
      </div>

      <div class="field">
        <div class="label"><span>Notes</span><span>Shown to customers</span></div>
        <textarea class="textarea" id="vNotes" placeholder="Financing, trade-ins, condition, etc."></textarea>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Photos</h3>
        <div class="hint">We upload to Cloudinary and save returned <span class="mono">secure_url</span> to Sheets.</div>

        <div class="row two">
          <div class="field">
            <div class="label"><span>Choose files</span><span>Images</span></div>
            <input class="input" id="files" type="file" multiple accept="image/*">
          </div>
          <div class="field">
            <div class="label"><span>Hero photo</span><span>Optional</span></div>
            <select class="select" id="heroPick">
              <option value="auto">Auto (first photo)</option>
            </select>
          </div>
        </div>

        <div class="statusline" id="uploadLine"></div>
      </div>

      <div class="footerBtns">
        <button class="btn" id="btnCancel" type="button">Cancel ×</button>
        <button class="btn btn-primary" id="btnSave" type="button">Save ✓</button>
      </div>

      <div class="statusline" id="mStatus"></div>
    </div>
  </div>
</div>

<div id="toast"><div id="toastDot"></div><div id="toastMsg"></div></div>

<script>
  const API = {
    login: () => "/api/dealer/login",
    vehicles: () => "/api/dealer/vehicles",
    config: () => "/api/public/config",

    // NEW: Signed Cloudinary params endpoint (you add this server route)
    // Expected response:
    // { ok:true, mode:"signed", apiKey:"...", timestamp:123, signature:"...", folder:"..." }
    // If you haven't added it yet, UI will fall back to unsigned preset uploads automatically.
    cloudinarySign: () => "/api/dealer/cloudinary/sign",
  };

  // Cloudinary config (loaded from server env via /api/public/config)
  const CLOUD = {
    cloudName: "",
    uploadPreset: "",
    baseFolder: "mediaexclusive",
  };

  const el = (id) => document.getElementById(id);

  const ui = {
    topTitle: el("topTitle"),
    topSub: el("topSub"),
    apiDot: el("apiDot"),
    apiText: el("apiText"),
    btnLogout: el("btnLogout"),

    loginView: el("loginView"),
    dashView: el("dashView"),

    dealerId: el("dealerId"),
    passcode: el("passcode"),
    btnLogin: el("btnLogin"),
    btnDemo: el("btnDemo"),
    loginStatus: el("loginStatus"),

    cfgLine: el("cfgLine"),

    q: el("q"),
    filterStatus: el("filterStatus"),
    sort: el("sort"),
    btnRefresh: el("btnRefresh"),
    btnAdd: el("btnAdd"),
    dashStatus: el("dashStatus"),
    count: el("count"),
    lastUpdated: el("lastUpdated"),
    tbody: el("tbody"),

    backdrop: el("backdrop"),
    mClose: el("mClose"),
    btnCancel: el("btnCancel"),
    btnSave: el("btnSave"),
    mTitle: el("mTitle"),
    mSub: el("mSub"),
    mStatus: el("mStatus"),

    vId: el("vId"),
    vStatus: el("vStatus"),
    vMake: el("vMake"),
    vModel: el("vModel"),
    vYear: el("vYear"),
    vPrice: el("vPrice"),
    vTitle: el("vTitle"),
    vNotes: el("vNotes"),

    files: el("files"),
    heroPick: el("heroPick"),
    uploadLine: el("uploadLine"),

    toast: el("toast"),
    toastDot: el("toastDot"),
    toastMsg: el("toastMsg"),
  };

  const state = {
    token: null,
    dealerId: null,
    dealerName: null,
    vehicles: [],
    editing: null,
    demo: false,

    // If server signed endpoint is missing, we'll flip this on and use unsigned preset.
    unsignedFallback: false,
  };

  document.addEventListener("DOMContentLoaded", async () => {
    wire();
    await loadConfig();
    restoreSession();
  });

  function wire(){
    ui.btnLogin.addEventListener("click", doLogin);
    ui.btnDemo.addEventListener("click", enterDemo);
    ui.passcode.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });

    ui.btnLogout.addEventListener("click", logout);

    ui.btnRefresh.addEventListener("click", loadVehicles);
    ui.btnAdd.addEventListener("click", ()=>openModal(null));

    ui.q.addEventListener("input", render);
    ui.filterStatus.addEventListener("change", render);
    ui.sort.addEventListener("change", render);

    ui.mClose.addEventListener("click", closeModal);
    ui.btnCancel.addEventListener("click", closeModal);
    ui.backdrop.addEventListener("click", (e)=>{ if(e.target===ui.backdrop) closeModal(); });

    ui.btnSave.addEventListener("click", saveVehicleAndUpload);
    ui.files.addEventListener("change", refreshHeroPicker);
  }

  async function loadConfig(){
    try{
      const res = await fetch(API.config(), { headers:{ "Accept":"application/json" } });
      const data = await res.json().catch(()=>null);
      if(!res.ok || !data || data.ok !== true) throw new Error("config load failed");

      CLOUD.cloudName = data.cloudinary?.cloudName || "";
      CLOUD.uploadPreset = data.cloudinary?.uploadPreset || "";
      CLOUD.baseFolder = data.cloudinary?.baseFolder || "mediaexclusive";

      if(!CLOUD.cloudName){
        ui.cfgLine.textContent = "Cloudinary config missing. Set CLOUDINARY_CLOUD_NAME on Cloud Run.";
        ui.cfgLine.classList.add("error");
      } else if(!CLOUD.uploadPreset){
        // Signed uploads don't require upload preset, but fallback unsigned does.
        ui.cfgLine.textContent = `Cloudinary ready: ${CLOUD.cloudName} · folder: ${CLOUD.baseFolder} (upload preset missing — signed uploads required)`;
      } else {
        ui.cfgLine.textContent = `Cloudinary ready: ${CLOUD.cloudName} · folder: ${CLOUD.baseFolder}`;
      }
    }catch{
      ui.cfgLine.textContent = "Could not load Cloudinary config from server.";
      ui.cfgLine.classList.add("error");
    }
  }

  function restoreSession(){
    const token = localStorage.getItem("dealer_token");
    const dealerId = localStorage.getItem("dealer_id");
    const dealerName = localStorage.getItem("dealer_name");
    if(token && dealerId){
      state.token = token;
      state.dealerId = dealerId;
      state.dealerName = dealerName || dealerId;
      state.demo = false;
      setApi("Live", "on");
      enterDashboard();
    } else {
      setApi("Offline", "err");
      ui.btnLogout.disabled = true;
    }
  }

  async function doLogin(){
    const dealerId = (ui.dealerId.value || "").trim();
    const passcode = (ui.passcode.value || "").trim();
    if(!dealerId || !passcode){
      setLoginStatus("Enter Dealer ID + passcode.", true);
      return;
    }
    setLoginStatus("Signing in…", false);

    try{
      const res = await fetch(API.login(), {
        method:"POST",
        headers:{ "Content-Type":"application/json", "Accept":"application/json" },
        body: JSON.stringify({ dealerId, passcode })
      });
      const data = await res.json().catch(()=>null);
      if(!res.ok || !data || data.ok !== true) throw new Error(data?.error || "Login failed");

      state.token = data.token;
      state.dealerId = data.dealerId || dealerId;
      state.dealerName = data.dealerName || dealerId;
      state.demo = false;

      localStorage.setItem("dealer_token", state.token);
      localStorage.setItem("dealer_id", state.dealerId);
      localStorage.setItem("dealer_name", state.dealerName);

      setApi("Live", "on");
      enterDashboard();
      toast("Signed in.", "success");
    }catch(e){
      setLoginStatus(String(e?.message || "Login failed"), true);
      setApi("Error", "err");
      toast("Login failed.", "error");
    }
  }

  function enterDemo(){
    state.demo = true;
    state.token = "demo-token";
    state.dealerId = "DEALER-0001";
    state.dealerName = "Demo Dealer";
    state.vehicles = demoVehicles();
    setApi("Demo", "off");
    enterDashboard();
    render();
    toast("Demo mode.", "success");
  }

  function logout(){
    state.token = null;
    state.dealerId = null;
    state.dealerName = null;
    state.vehicles = [];
    state.demo = false;
    state.unsignedFallback = false;

    localStorage.removeItem("dealer_token");
    localStorage.removeItem("dealer_id");
    localStorage.removeItem("dealer_name");

    ui.dashView.classList.add("hidden");
    ui.loginView.classList.remove("hidden");
    ui.btnLogout.disabled = true;
    ui.topTitle.textContent = "Dealer Portal";
    ui.topSub.textContent = "Log in to manage inventory + photos.";
    setLoginStatus("", false);
    setApi("Offline", "err");
    toast("Logged out.", "success");
  }

  function enterDashboard(){
    ui.loginView.classList.add("hidden");
    ui.dashView.classList.remove("hidden");
    ui.btnLogout.disabled = false;

    ui.topTitle.textContent = state.dealerName || "Dealer Portal";
    ui.topSub.textContent = `${state.dealerId || ""} · inventory & media`;
    loadVehicles();
  }

  async function loadVehicles(){
    ui.dashStatus.textContent = state.demo ? "Demo inventory loaded." : "Loading vehicles…";
    if(state.demo){
      ui.lastUpdated.textContent = "Updated: " + fmt(new Date());
      render();
      return;
    }

    try{
      const res = await fetch(API.vehicles(), {
        headers:{
          "Accept":"application/json",
          "Authorization":"Bearer " + state.token
        }
      });
      const data = await res.json().catch(()=>null);
      if(!res.ok || !data || data.ok !== true) throw new Error(data?.error || "Failed to load");

      state.vehicles = normalize(data.vehicles || []);
      ui.dashStatus.textContent = "Ready.";
      ui.lastUpdated.textContent = "Updated: " + fmt(new Date());
      setApi("Live", "on");
      render();
    }catch(e){
      ui.dashStatus.textContent = String(e?.message || "Could not load vehicles.");
      setApi("Error", "err");
      toast("Failed to load inventory.", "error");
    }
  }

  function render(){
    const q = (ui.q.value || "").trim().toLowerCase();
    const fs = (ui.filterStatus.value || "").trim().toLowerCase();
    const sort = ui.sort.value || "newest";

    let list = [...state.vehicles];

    if(q) list = list.filter(v => blob(v).includes(q));
    if(fs) list = list.filter(v => (String(v.status||"available").toLowerCase() === fs));

    list.sort((a,b)=>{
      if(sort==="priceAsc") return (a.price||0)-(b.price||0);
      if(sort==="priceDesc") return (b.price||0)-(a.price||0);
      if(sort==="yearAsc") return (a.year||0)-(b.year||0);
      if(sort==="yearDesc") return (b.year||0)-(a.year||0);
      return new Date(b.updatedAt || b.createdAt || 0).getTime() - new Date(a.updatedAt || a.createdAt || 0).getTime();
    });

    ui.tbody.innerHTML = "";
    ui.count.textContent = String(list.length);

    if(!list.length){
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 5;
      td.style.color = "var(--muted)";
      td.style.padding = "14px";
      td.textContent = "No vehicles match your filters.";
      tr.appendChild(td);
      ui.tbody.appendChild(tr);
      return;
    }

    list.forEach(v=>{
      const tr = document.createElement("tr");
      tr.addEventListener("click", ()=>openModal(v));

      const td1 = document.createElement("td");
      td1.innerHTML = `<div class="mono">${esc(v.vehicleId)}</div>
                       <div style="color:var(--muted);font-size:11px;margin-top:2px">${esc(v.make)} ${esc(v.model)}</div>`;

      const td2 = document.createElement("td");
      td2.innerHTML = `<div>${esc(v.year?String(v.year):"—")}</div>
                       <div style="color:var(--muted);font-size:11px;margin-top:2px">${esc(v.title||"")}</div>`;

      const td3 = document.createElement("td");
      const s = String(v.status||"available").toLowerCase();
      td3.innerHTML = `<span class="tag ${esc(s)}">${esc(s)}</span>`;

      const td4 = document.createElement("td");
      td4.innerHTML = `<div style="font-weight:900">${money(v.price)}</div>`;

      const td5 = document.createElement("td");
      td5.innerHTML = `<div>${(v.images||[]).length} photos</div>
                       <div style="color:var(--muted);font-size:11px;margin-top:2px">${v.heroImage ? "Hero set" : "No hero"}</div>`;

      tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4); tr.appendChild(td5);
      ui.tbody.appendChild(tr);
    });
  }

  function openModal(v){
    state.editing = v ? deepClone(v) : null;
    ui.mTitle.textContent = v ? "Edit vehicle" : "Add vehicle";
    ui.mStatus.textContent = "";
    ui.mStatus.classList.remove("error");
    ui.uploadLine.textContent = "";

    ui.vId.value = v?.vehicleId || "";
    ui.vStatus.value = (v?.status || "available").toLowerCase();
    ui.vMake.value = v?.make || "";
    ui.vModel.value = v?.model || "";
    ui.vYear.value = v?.year || "";
    ui.vPrice.value = v?.price || "";
    ui.vTitle.value = v?.title || "";
    ui.vNotes.value = v?.notes || "";
    ui.files.value = "";

    refreshHeroPicker(v?.images || []);
    ui.backdrop.classList.add("show");
    ui.backdrop.setAttribute("aria-hidden","false");
  }

  function closeModal(){
    ui.backdrop.classList.remove("show");
    ui.backdrop.setAttribute("aria-hidden","true");
    state.editing = null;
  }

  function refreshHeroPicker(existingImages){
    const imgs = Array.isArray(existingImages) ? existingImages.slice() : [];
    const newFiles = ui.files.files ? Array.from(ui.files.files) : [];

    ui.heroPick.innerHTML = "";
    const optAuto = document.createElement("option");
    optAuto.value = "auto";
    optAuto.textContent = "Auto (first photo)";
    ui.heroPick.appendChild(optAuto);

    imgs.forEach((u, i)=>{
      const o = document.createElement("option");
      o.value = "existing:" + i;
      o.textContent = `Existing #${i+1}`;
      ui.heroPick.appendChild(o);
    });

    newFiles.forEach((f, i)=>{
      const o = document.createElement("option");
      o.value = "new:" + i;
      o.textContent = `New: ${f.name}`;
      ui.heroPick.appendChild(o);
    });
  }

  // ✅ Main flow:
  // 1) Save vehicle first -> ensures vehicleId exists in Sheets
  // 2) Request SIGNED upload params from server (recommended)
  // 3) Upload images to Cloudinary -> get secure_url
  // 4) Merge images, set hero automatically (or chosen), save again -> Sheets/storefront updated
  async function saveVehicleAndUpload(){
    const payload = buildPayload();
    if(!payload.make || !payload.model){
      setMStatus("Make + Model are required.", true);
      return;
    }
    if(!CLOUD.cloudName){
      setMStatus("Cloudinary config missing (CLOUDINARY_CLOUD_NAME).", true);
      return;
    }
    if(!state.demo && !state.token){
      setMStatus("Not logged in.", true);
      return;
    }

    ui.btnSave.disabled = true;
    ui.uploadLine.textContent = "";
    setMStatus("Saving…", false);

    try{
      // (1) Save first (vehicleId generated server-side if blank)
      const savedBase = await saveVehicle({
        vehicleId: payload.vehicleId || "",
        title: payload.title,
        make: payload.make,
        model: payload.model,
        year: payload.year,
        price: payload.price,
        status: payload.status,
        notes: payload.notes,
        images: payload.images || [],
        heroImage: payload.heroImage || "",
      });

      const files = ui.files.files ? Array.from(ui.files.files) : [];
      let uploadedUrls = [];

      if(files.length && !state.demo){
        ui.uploadLine.textContent = `Uploading ${files.length} photo(s)…`;

        // (2) Ask server for signed upload params (recommended)
        // If endpoint not available, fallback to unsigned preset upload (needs CLOUDINARY_UPLOAD_PRESET)
        const signer = await getCloudinarySigner(savedBase.vehicleId);

        // (3) Upload
        uploadedUrls = await uploadFilesToCloudinary(savedBase.vehicleId, files, signer);
      }

      const existingImages = Array.isArray(payload.images) ? payload.images : [];
      const mergedImages = [...existingImages, ...uploadedUrls].filter(Boolean);

      // (4) Hero selection + auto
      const heroImage = pickHero({
        heroPick: ui.heroPick.value,
        existingImages,
        newUploaded: uploadedUrls
      }) || (mergedImages[0] || "");

      // Save final URLs to Sheets
      await saveVehicle({
        vehicleId: savedBase.vehicleId,
        title: payload.title,
        make: payload.make,
        model: payload.model,
        year: payload.year,
        price: payload.price,
        status: payload.status,
        notes: payload.notes,
        images: mergedImages,
        heroImage: heroImage
      });

      toast(files.length ? "Vehicle saved + photos uploaded." : "Vehicle saved.", "success");
      closeModal();
      await loadVehicles();
    }catch(e){
      setMStatus(String(e?.message || "Save failed."), true);
      toast("Save failed.", "error");
    }finally{
      ui.btnSave.disabled = false;
    }
  }

  function buildPayload(){
    const vehicleId = (ui.vId.value || "").trim();
    return {
      vehicleId: vehicleId || "",
      status: (ui.vStatus.value || "available").toLowerCase(),
      make: (ui.vMake.value || "").trim(),
      model: (ui.vModel.value || "").trim(),
      year: numOrNull(ui.vYear.value),
      price: num(ui.vPrice.value),
      title: (ui.vTitle.value || "").trim(),
      notes: (ui.vNotes.value || "").trim(),
      images: Array.isArray(state.editing?.images) ? state.editing.images : [],
      heroImage: (state.editing?.heroImage || "")
    };
  }

  async function saveVehicle(payload){
    if(state.demo){
      const id = payload.vehicleId || genVehicleId();
      const merged = {
        ...payload,
        vehicleId: id,
        dealerId: state.dealerId,
        updatedAt: new Date().toISOString()
      };
      const idx = state.vehicles.findIndex(x=>x.vehicleId===id);
      if(idx>-1) state.vehicles[idx] = { ...state.vehicles[idx], ...merged };
      else state.vehicles.unshift(merged);
      return merged;
    }

    const res = await fetch(API.vehicles(), {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Accept":"application/json",
        "Authorization":"Bearer " + state.token
      },
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(()=>null);
    if(!res.ok || !data || data.ok !== true) throw new Error(data?.error || "Vehicle save failed");
    return normalize([data.vehicle])[0];
  }

  // -----------------------------
  // SIGNED UPLOAD SUPPORT
  // -----------------------------

  // Returns a "signer" object used by upload calls.
  // signer.mode: "signed" | "unsigned"
  // signed => { apiKey, timestamp, signature, folder }
  // unsigned => { uploadPreset, folder }
  async function getCloudinarySigner(vehicleId){
    // If we've already decided signed endpoint isn't there, skip trying again.
    if(state.unsignedFallback){
      if(!CLOUD.uploadPreset) throw new Error("Unsigned upload preset missing (CLOUDINARY_UPLOAD_PRESET).");
      return { mode:"unsigned", uploadPreset: CLOUD.uploadPreset, folder: makeFolder(vehicleId) };
    }

    try{
      const folder = makeFolder(vehicleId);

      const res = await fetch(API.cloudinarySign(), {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Accept":"application/json",
          "Authorization":"Bearer " + state.token
        },
        body: JSON.stringify({
          folder,
          // you can also send other upload params that the server should sign:
          // eager, tags, context, etc
        })
      });

      // If endpoint isn't there yet, Cloud Run will typically return 404
      if(res.status === 404){
        state.unsignedFallback = true;
        if(!CLOUD.uploadPreset) {
          throw new Error("Signed upload endpoint not found, and CLOUDINARY_UPLOAD_PRESET is missing for fallback.");
        }
        ui.uploadLine.textContent = "Signed endpoint not found — falling back to unsigned preset upload.";
        return { mode:"unsigned", uploadPreset: CLOUD.uploadPreset, folder };
      }

      const data = await res.json().catch(()=>null);
      if(!res.ok || !data || data.ok !== true) throw new Error(data?.error || "Could not get signed upload params");

      // Expected fields
      const apiKey = data.apiKey || data.cloudinaryApiKey || "";
      const timestamp = data.timestamp;
      const signature = data.signature || "";
      const signedFolder = data.folder || folder;

      if(!apiKey || !timestamp || !signature) throw new Error("Signed upload params incomplete (apiKey/timestamp/signature).");

      return {
        mode: "signed",
        apiKey,
        timestamp,
        signature,
        folder: signedFolder,
      };
    }catch(err){
      // Fallback to unsigned preset if possible
      if(CLOUD.uploadPreset){
        state.unsignedFallback = true;
        ui.uploadLine.textContent = "Signed upload failed — using unsigned preset fallback.";
        return { mode:"unsigned", uploadPreset: CLOUD.uploadPreset, folder: makeFolder(vehicleId) };
      }
      // If no fallback, bubble error
      throw err;
    }
  }

  function makeFolder(vehicleId){
    // Folder strategy: baseFolder/dealers/<dealerId>/vehicles/<vehicleId>
    return `${CLOUD.baseFolder}/dealers/${state.dealerId}/vehicles/${vehicleId}`;
  }

  async function uploadOneToCloudinary(file, signer){
    const url = `https://api.cloudinary.com/v1_1/${encodeURIComponent(CLOUD.cloudName)}/image/upload`;
    const fd = new FormData();
    fd.append("file", file);

    // Always set folder (either signed or unsigned)
    fd.append("folder", signer.folder);

    if(signer.mode === "signed"){
      fd.append("api_key", signer.apiKey);
      fd.append("timestamp", String(signer.timestamp));
      fd.append("signature", signer.signature);
      // (Optional) keep filename behavior consistent
      // fd.append("use_filename", "true");
      // fd.append("unique_filename", "true");
    } else {
      // unsigned
      fd.append("upload_preset", signer.uploadPreset);
    }

    const res = await fetch(url, { method:"POST", body: fd });
    const json = await res.json().catch(()=>null);

    if(!res.ok){
      const msg = json?.error?.message || `Cloudinary upload failed (${res.status})`;
      throw new Error(msg);
    }

    // ✅ secure_url is what we store into Sheets
    return json.secure_url || json.url;
  }

  async function uploadFilesToCloudinary(vehicleId, files, signer){
    const out = [];
    for(let i=0;i<files.length;i++){
      const f = files[i];
      ui.uploadLine.textContent = `Uploading ${i+1}/${files.length}: ${f.name}`;
      const secureUrl = await uploadOneToCloudinary(f, signer);
      out.push(secureUrl);
    }
    ui.uploadLine.textContent = `Uploaded ${out.length}/${files.length}.`;
    return out;
  }

  function pickHero({ heroPick, existingImages, newUploaded }){
    if(heroPick === "auto"){
      return (newUploaded[0] || existingImages[0] || "");
    }
    if(heroPick.startsWith("existing:")){
      const idx = Number(heroPick.split(":")[1]||0);
      return existingImages[idx] || "";
    }
    if(heroPick.startsWith("new:")){
      const idx = Number(heroPick.split(":")[1]||0);
      return newUploaded[idx] || (newUploaded[0]||"");
    }
    return "";
  }

  function setApi(text, mode){
    ui.apiText.textContent = text || "—";
    ui.apiDot.classList.remove("on","err");
    if(mode==="on") ui.apiDot.classList.add("on");
    if(mode==="err") ui.apiDot.classList.add("err");
  }
  function setLoginStatus(msg, err){
    ui.loginStatus.textContent = msg || "";
    ui.loginStatus.classList.toggle("error", !!err);
  }
  function setMStatus(msg, err){
    ui.mStatus.textContent = msg || "";
    ui.mStatus.classList.toggle("error", !!err);
  }
  function toast(message, type){
    ui.toastMsg.textContent = message || "";
    ui.toast.classList.remove("success","error");
    if(type==="success"){ ui.toast.classList.add("success"); ui.toastDot.style.background="#22c55e"; }
    else if(type==="error"){ ui.toast.classList.add("error"); ui.toastDot.style.background="#fb7185"; }
    else ui.toastDot.style.background="var(--brand)";
    ui.toast.classList.add("show");
    clearTimeout(window.__t);
    window.__t = setTimeout(()=>ui.toast.classList.remove("show"), 3200);
  }

  function normalize(list){
    return (list||[]).map(v => ({
      vehicleId: v.vehicleId || genVehicleId(),
      dealerId: v.dealerId || state.dealerId,
      title: v.title || "",
      make: v.make || "",
      model: v.model || "",
      year: (v.year!=null && v.year!=="") ? Number(v.year) : null,
      price: Number(v.price||0) || 0,
      status: (v.status || "available").toLowerCase(),
      notes: v.notes || "",
      heroImage: v.heroImage || "",
      images: Array.isArray(v.images) ? v.images : [],
      updatedAt: v.updatedAt || v.createdAt || new Date().toISOString(),
      createdAt: v.createdAt || v.updatedAt || new Date().toISOString()
    }));
  }

  function demoVehicles(){
    return normalize([
      { vehicleId:"VEH-10021", make:"Toyota", model:"Vitz", year:2018, price:1250000, status:"available", notes:"Clean unit.", images:["https://example.com/a.jpg","https://example.com/b.jpg"], heroImage:"https://example.com/a.jpg" },
      { vehicleId:"VEH-10022", make:"Honda", model:"Civic", year:2017, price:2200000, status:"pending", notes:"Pending deposit.", images:["https://example.com/c.jpg"] },
    ]);
  }

  function blob(v){
    return [v.vehicleId,v.title,v.make,v.model,v.year,v.notes]
      .filter(Boolean).join(" ").toLowerCase();
  }
  function money(n){
    const v = Number(n);
    if(!Number.isFinite(v) || v<=0) return "Price on request";
    return "JMD " + v.toLocaleString(undefined,{maximumFractionDigits:0});
  }
  function fmt(d){
    const dt = (d instanceof Date)?d:new Date(d);
    const day = String(dt.getDate()).padStart(2,"0");
    const mon = String(dt.getMonth()+1).padStart(2,"0");
    const yr = String(dt.getFullYear()).slice(-2);
    const hr = String(dt.getHours()).padStart(2,"0");
    const mi = String(dt.getMinutes()).padStart(2,"0");
    return `${day}/${mon}/${yr} ${hr}:${mi}`;
  }
  function num(v){
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }
  function numOrNull(v){
    if(v === "" || v == null) return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }
  function genVehicleId(){
    return "VEH-" + Math.random().toString(16).slice(2,8).toUpperCase();
  }
  function deepClone(x){ return JSON.parse(JSON.stringify(x||null)); }
  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");
  }
</script>
</body>
</html>
