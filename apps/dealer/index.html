<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Carsales – Dealer</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --surface:#ffffff;
      --surface2:#fbfbfd;
      --ink:#0f172a;
      --muted:#64748b;
      --muted2:#94a3b8;
      --line:#e5e7eb;
      --shadow:0 18px 40px rgba(15, 23, 42, 0.12);
      --shadow2:0 10px 24px rgba(15, 23, 42, 0.08);
      --brand:#dc2626;
      --brand2:#ef4444;
      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --radius:18px;
      --sans: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(circle at top left, rgba(220,38,38,.08), transparent 45%),
        radial-gradient(circle at bottom right, rgba(239,68,68,.06), transparent 55%),
        var(--bg);
      -webkit-font-smoothing:antialiased;
    }
    a{color:inherit;text-decoration:none}
    .hidden{display:none!important}

    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}
    .shell{
      width:100%;
      max-width:1180px;
      background: rgba(255,255,255,.92);
      border:1px solid var(--line);
      border-radius:28px;
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }

    .top{
      display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;
      padding:16px 18px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(90deg, rgba(255,255,255,.96), rgba(255,255,255,.92));
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:44px;height:44px;border-radius:14px;
      display:grid;place-items:center;
      background: radial-gradient(circle at 20% 20%, #fff, #fee2e2 55%, rgba(220,38,38,.25));
      box-shadow:0 14px 30px rgba(220,38,38,.18);
      font-weight:900;
    }
    .title{font-weight:850;letter-spacing:.02em}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      background: rgba(255,255,255,.90);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      box-shadow: var(--shadow2);
    }
    .dot{width:9px;height:9px;border-radius:99px;background:var(--warn);box-shadow:0 0 0 4px rgba(251,191,36,.20)}
    .dot.on{background:var(--good);box-shadow:0 0 0 4px rgba(34,197,94,.22)}
    .dot.err{background:var(--bad);box-shadow:0 0 0 4px rgba(251,113,133,.20)}

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.90);
      color:var(--ink);
      border-radius:999px;
      padding:10px 14px;
      font-weight:750;
      font-size:12px;
      cursor:pointer;
      display:inline-flex;align-items:center;gap:8px;
      transition:transform .10s ease, background .12s ease, border-color .12s ease, box-shadow .12s ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow2)}
    .btn:disabled{opacity:.55;cursor:not-allowed;transform:none}
    .btn-primary{
      border-color:rgba(220,38,38,.25);
      background: linear-gradient(135deg, var(--brand2), var(--brand));
      color:#fff;
      box-shadow:0 16px 32px rgba(220,38,38,.24);
    }

    .content{padding:18px}
    .grid{display:grid;grid-template-columns: 1fr;gap:14px}
    @media(min-width:980px){.grid{grid-template-columns: .42fr .58fr}}

    .kpis{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:10px;
      margin-bottom:14px;
    }
    .kpi{
      background: var(--surface2);
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      box-shadow: var(--shadow2);
    }
    .kpi .t{font-size:11px;color:var(--muted)}
    .kpi .v{font-size:18px;font-weight:900}
    .kpi .s{font-size:11px;color:var(--muted2)}

    .card{
      background: var(--surface);
      border:1px solid var(--line);
      border-radius:22px;
      padding:14px;
      box-shadow: var(--shadow2);
    }
    .login-logo{
      width:48px;
      height:48px;
      border-radius:14px;
      border:1px solid var(--line);
      box-shadow: var(--shadow2);
      object-fit:cover;
      background: var(--surface2);
    }
    .card h3{margin:0 0 6px;font-size:13px;font-weight:900;letter-spacing:.03em}
    .hint{color:var(--muted);font-size:12px;line-height:1.35}
    .statusline{min-height:18px;margin-top:8px;color:var(--muted);font-size:12px}
    .statusline.error{color:var(--bad)}
    .mono{font-family:var(--mono)}

    .field{margin-top:10px}
    .label{display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:11px;margin-bottom:6px}
    .input,.select,.textarea{
      width:100%;
      background: rgba(255,255,255,.96);
      border:1px solid var(--line);
      border-radius:16px;
      padding:11px 12px;
      color:var(--ink);
      outline:none;
      font-size:13px;
      transition:border-color .15s ease, transform .08s ease, background .15s ease;
    }
    .input:focus,.select:focus,.textarea:focus{
      border-color: rgba(220,38,38,.45);
      box-shadow: 0 0 0 4px rgba(220,38,38,.12);
      transform: translateY(-1px);
    }
    .textarea{min-height:96px;resize:vertical}

    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:560px){.row.two{grid-template-columns:1fr 1fr}}
    @media(min-width:820px){.row.three{grid-template-columns:1fr 1fr 1fr}}

    .table{
      overflow:hidden;border-radius:22px;border:1px solid var(--line);
      background: var(--surface);
    }
    .thead{
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background: var(--surface2);
    }
    .thead .t{font-weight:900;font-size:13px}
    .thead .m{color:var(--muted);font-size:12px}
    .scroll{max-height:560px;overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{padding:10px 10px;border-bottom:1px solid var(--line);text-align:left}
    th{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    tbody tr{cursor:pointer}
    tbody tr:hover{background:rgba(15,23,42,.04)}
    .tag{
      display:inline-flex;align-items:center;
      padding:4px 10px;border-radius:999px;
      font-size:10px;font-weight:900;letter-spacing:.08em;text-transform:uppercase;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.04);
      color: var(--muted);
    }
    .tag.available{border-color:rgba(22,163,74,.30);color:#166534;background:rgba(22,163,74,.12)}
    .tag.pending{border-color:rgba(245,158,11,.30);color:#92400e;background:rgba(245,158,11,.12)}
    .tag.sold{border-color:rgba(239,68,68,.30);color:#991b1b;background:rgba(239,68,68,.10)}
    .tag.new{border-color:rgba(15,23,42,.10);color:var(--ink);background:rgba(15,23,42,.05)}
    .tag.booked{border-color:rgba(22,163,74,.30);color:#166534;background:rgba(22,163,74,.12)}
    .tag.closed{border-color:rgba(15,23,42,.12);color:var(--muted);background:rgba(15,23,42,.04)}

    .thumb{
      width:48px;height:36px;border-radius:10px;object-fit:cover;border:1px solid var(--line);
      background: rgba(15,23,42,.04);
    }

    .galleryGrid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
      gap:10px;
      margin-top:10px;
    }
    .galleryItem{
      border-radius:14px;
      border:1px solid var(--line);
      background: var(--surface2);
      padding:8px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .galleryItem img{
      width:100%;
      height:88px;
      border-radius:10px;
      object-fit:cover;
      background: rgba(15,23,42,.04);
    }
    .galleryActions{display:flex;gap:6px;flex-wrap:wrap}
    .galleryActions .btn{padding:6px 10px;font-size:10px}
    .btn-mini{padding:6px 10px;font-size:10px}

    /* Modal */
    .backdrop{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background: rgba(15,23,42,.35);
      backdrop-filter: blur(10px);
      padding:16px;
      z-index:60;
    }
    .backdrop.show{display:flex}
    .modal{
      width:100%;
      max-width:980px;
      border-radius:26px;
      border:1px solid var(--line);
      background: var(--surface);
      box-shadow: 0 28px 60px rgba(15,23,42,.24);
      overflow:hidden;
    }
    .mhead{
      padding:14px 16px;
      display:flex;justify-content:space-between;align-items:flex-start;gap:12px;
      border-bottom:1px solid var(--line);
      background: var(--surface2);
    }
    .mhead h3{margin:0;font-size:14px;font-weight:950}
    .xbtn{
      width:36px;height:36px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.90);
      color:var(--ink);
      cursor:pointer;
      font-size:18px;
    }
    .xbtn:hover{background:rgba(15,23,42,.04)}
    .mbody{padding:16px}
    .footerBtns{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;margin-top:12px}

    /* Toast */
    #toast{
      position:fixed;right:16px;bottom:16px;z-index:80;
      display:none;align-items:center;gap:10px;
      padding:10px 14px;border-radius:999px;
      background: rgba(255,255,255,.96);
      border:1px solid var(--line);
      color:var(--muted);
      box-shadow: var(--shadow2);
    }
    #toast.show{display:flex}
    #toastDot{width:10px;height:10px;border-radius:99px;background:var(--brand)}
    #toast.success{border-color:rgba(22,163,74,.30);color:#166534}
    #toast.error{border-color:rgba(239,68,68,.30);color:#991b1b}
  </style>
</head>

<body>
<div class="wrap">
  <div class="shell">

    <div class="top">
      <div class="brand">
        <div class="logo">D</div>
        <div>
          <div class="title" id="topTitle">Dealer Portal</div>
          <div class="sub" id="topSub">Manage inventory, pricing, and media in one place.</div>
        </div>
      </div>
      <div class="actions">
        <div class="pill">
          <span class="dot" id="apiDot"></span>
          <span id="apiText">Offline</span>
        </div>
        <a class="btn" id="storefrontLink" href="/storefront">Storefront ↗</a>
        <button class="btn" id="btnLogout" type="button">Logout ⎋</button>
      </div>
    </div>

    <div class="content">
      <!-- LOGIN -->
      <div class="grid" id="loginView">
        <div class="card">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">
            <img class="login-logo" src="https://res.cloudinary.com/dd8pjjxsm/image/upload/v1768234190/ChatGPT_Image_Sep_6_2025_08_27_53_AM_xd60o7.png" alt="Pytch logo" />
            <div>
              <h3 style="margin:0">Sign in</h3>
              <div class="hint" style="margin-top:4px">Enter your dealer passcode to access inventory.</div>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="field">
              <div class="label"><span>Passcode</span><span>Required</span></div>
              <input class="input" id="passcode" type="password" placeholder="123456" autocomplete="current-password">
            </div>
          </div>

          <div class="footerBtns">
            <button class="btn" id="btnDemo" type="button">Demo ★</button>
            <button class="btn btn-primary" id="btnLogin" type="button">Sign in →</button>
          </div>

          <div class="statusline" id="loginStatus"></div>
        </div>

        <div class="card">
          <h3>Photo storage</h3>
          <div class="hint">
            Photos are stored securely in the shared media library. Once saved, they appear on the storefront instantly.
            If uploads pause, check your connection or contact support.
          </div>
          <div class="statusline" id="cfgLine"></div>
        </div>
      </div>

      <!-- DASH -->
      <div class="hidden" id="dashView">
        <div class="kpis" id="kpiRow">
          <div class="kpi">
            <div class="t">Total inventory</div>
            <div class="v" id="kTotal">0</div>
            <div class="s">Vehicles listed</div>
          </div>
          <div class="kpi">
            <div class="t">Available</div>
            <div class="v" id="kAvailable">0</div>
            <div class="s">Ready for sale</div>
          </div>
          <div class="kpi">
            <div class="t">Pending</div>
            <div class="v" id="kPending">0</div>
            <div class="s">In negotiation</div>
          </div>
          <div class="kpi">
            <div class="t">Sold</div>
            <div class="v" id="kSold">0</div>
            <div class="s">Closed sales</div>
          </div>
          <div class="kpi">
            <div class="t">Total requests</div>
            <div class="v" id="kRequests">0</div>
            <div class="s">Leads received</div>
          </div>
          <div class="kpi">
            <div class="t">New today</div>
            <div class="v" id="kNewToday">0</div>
            <div class="s">Requests today</div>
          </div>
          <div class="kpi">
            <div class="t">Booked</div>
            <div class="v" id="kBooked">0</div>
            <div class="s">Confirmed viewings</div>
          </div>
        </div>

        <div class="grid">
          <div class="card">
          <h3>Controls</h3>
          <div class="hint">Search / filter your inventory.</div>

          <div class="field">
            <div class="label"><span>Search</span><span>Vehicle / Make / Model</span></div>
            <input class="input" id="q" placeholder="Search…">
          </div>

          <div class="row two">
            <div class="field">
              <div class="label"><span>Status</span><span>Filter</span></div>
              <select class="select" id="filterStatus">
                <option value="">All</option>
                <option value="available">Available</option>
                <option value="pending">Pending</option>
                <option value="sold">Sold</option>
              </select>
            </div>
            <div class="field">
              <div class="label"><span>Sort</span><span>Default</span></div>
              <select class="select" id="sort">
                <option value="newest">Newest</option>
                <option value="priceAsc">Price: Low → High</option>
                <option value="priceDesc">Price: High → Low</option>
                <option value="yearDesc">Year: New → Old</option>
                <option value="yearAsc">Year: Old → New</option>
              </select>
            </div>
          </div>

          <div class="footerBtns">
            <button class="btn" id="btnRefresh" type="button">Refresh ⟳</button>
            <button class="btn btn-primary" id="btnAdd" type="button">Add vehicle ＋</button>
            <button class="btn" id="btnExportInventory" type="button">Export inventory CSV</button>
          </div>

          <div class="statusline" id="dashStatus"></div>
        </div>

          <div class="table">
          <div class="thead">
            <div>
              <div class="t">Your vehicles</div>
              <div class="m">Showing <span id="count">0</span> vehicles</div>
            </div>
            <div class="m" id="lastUpdated">—</div>
          </div>

          <div class="scroll">
            <table>
              <thead>
                <tr>
                  <th>Vehicle</th>
                  <th>Specs</th>
                  <th>Status</th>
                  <th>Price</th>
                  <th>Media</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
          </div>
        </div>

        <div class="card" id="requestsCard" style="margin-top:14px">
          <h3>Requests</h3>
          <div class="hint">Track new leads and update their status.</div>

          <div class="row two" style="margin-top:10px">
            <div class="field">
              <div class="label"><span>Status</span><span>Filter</span></div>
              <select class="select" id="leadStatusFilter">
                <option value="">All</option>
                <option value="new">New</option>
                <option value="booked">Booked</option>
                <option value="closed">Closed</option>
              </select>
            </div>
            <div class="field">
              <div class="label"><span>Date range</span><span>Filter</span></div>
              <div class="row two">
                <input class="input" id="leadStart" type="date" />
                <input class="input" id="leadEnd" type="date" />
              </div>
            </div>
          </div>

          <div class="footerBtns" style="justify-content:flex-start">
            <button class="btn" id="btnLeadsRefresh" type="button">Refresh requests</button>
            <button class="btn" id="btnExportLeads" type="button">Export CSV</button>
          </div>

          <div class="table" style="margin-top:10px">
            <div class="thead">
              <div>
                <div class="t">Incoming requests</div>
                <div class="m">Showing <span id="leadCount">0</span> requests</div>
              </div>
              <div class="m" id="leadUpdated">—</div>
            </div>
            <div class="scroll">
              <table>
                <thead>
                  <tr>
                    <th>Customer</th>
                    <th>Vehicle</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Requested</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="leadBody"></tbody>
              </table>
            </div>
          </div>

          <div class="statusline" id="leadStatus"></div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- MODAL -->
<div class="backdrop" id="backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Vehicle editor">
    <div class="mhead">
      <div>
        <h3 id="mTitle">Add vehicle</h3>
        <div class="sub" id="mSub">Save vehicle details and upload photos.</div>
      </div>
      <button class="xbtn" id="mClose" type="button" aria-label="Close">×</button>
    </div>

    <div class="mbody">
      <div class="row two">
        <div class="field">
          <div class="label"><span>Vehicle ID</span><span>Auto if empty</span></div>
          <input class="input mono" id="vId" placeholder="VEH-12345">
        </div>
        <div class="field">
          <div class="label"><span>Status</span><span>Required</span></div>
          <select class="select" id="vStatus">
            <option value="available">Available</option>
            <option value="pending">Pending</option>
            <option value="sold">Sold</option>
          </select>
        </div>
      </div>

      <div class="row two">
        <div class="field">
          <div class="label"><span>Make</span><span>Required</span></div>
          <input class="input" id="vMake" placeholder="Honda">
        </div>
        <div class="field">
          <div class="label"><span>Model</span><span>Required</span></div>
          <input class="input" id="vModel" placeholder="Civic">
        </div>
      </div>

      <div class="row three">
        <div class="field">
          <div class="label"><span>Year</span><span>Optional</span></div>
          <input class="input" id="vYear" type="number" placeholder="2018">
        </div>
        <div class="field">
          <div class="label"><span>Price (JMD)</span><span>Optional</span></div>
          <input class="input" id="vPrice" type="number" placeholder="1250000">
        </div>
        <div class="field">
          <div class="label"><span>Title</span><span>Optional</span></div>
          <input class="input" id="vTitle" placeholder="2018 Honda Civic — Clean unit">
        </div>
      </div>

      <div class="field">
        <div class="label"><span>Notes</span><span>Shown to customers</span></div>
        <textarea class="textarea" id="vNotes" placeholder="Financing, trade-ins, condition, etc."></textarea>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Photos</h3>
        <div class="hint">Upload up to 7 images. Set the hero image for storefront display.</div>

        <div class="row two">
          <div class="field">
            <div class="label"><span>Choose files</span><span>Images (max 7)</span></div>
            <input class="input" id="files" type="file" multiple accept="image/*">
          </div>
        </div>

        <div class="galleryGrid" id="galleryGrid"></div>
        <input class="hidden" id="replaceFile" type="file" accept="image/*" />

        <div class="statusline" id="uploadLine"></div>
      </div>

      <div class="footerBtns">
        <button class="btn" id="btnCancel" type="button">Cancel ×</button>
        <button class="btn btn-primary" id="btnSave" type="button">Save ✓</button>
      </div>

      <div class="statusline" id="mStatus"></div>
    </div>
  </div>
</div>

<div id="toast"><div id="toastDot"></div><div id="toastMsg"></div></div>

<script>
  const API = {
    login: () => "/api/dealer/login",
    vehicles: () => "/api/dealer/vehicles",
    leads: () => "/api/dealer/leads",
    leadStatus: () => "/api/dealer/leads/status",
    config: () => "/api/public/config",

    // NEW: Signed Cloudinary params endpoint (you add this server route)
    // Expected response:
    // { ok:true, mode:"signed", apiKey:"...", timestamp:123, signature:"...", folder:"..." }
    // If you haven't added it yet, UI will fall back to unsigned preset uploads automatically.
    cloudinarySign: () => "/api/dealer/cloudinary/sign",
  };

  // Cloudinary config (loaded from server env via /api/public/config)
  const CLOUD = {
    cloudName: "",
    uploadPreset: "",
    baseFolder: "mediaexclusive",
  };

  const el = (id) => document.getElementById(id);

  const ui = {
    topTitle: el("topTitle"),
    topSub: el("topSub"),
    apiDot: el("apiDot"),
    apiText: el("apiText"),
    btnLogout: el("btnLogout"),
    storefrontLink: el("storefrontLink"),

    loginView: el("loginView"),
    dashView: el("dashView"),
    kTotal: el("kTotal"),
    kAvailable: el("kAvailable"),
    kPending: el("kPending"),
    kSold: el("kSold"),
    kRequests: el("kRequests"),
    kNewToday: el("kNewToday"),
    kBooked: el("kBooked"),

    dealerId: el("dealerId"),
    passcode: el("passcode"),
    btnLogin: el("btnLogin"),
    btnDemo: el("btnDemo"),
    loginStatus: el("loginStatus"),

    cfgLine: el("cfgLine"),

    q: el("q"),
    filterStatus: el("filterStatus"),
    sort: el("sort"),
    btnRefresh: el("btnRefresh"),
    btnAdd: el("btnAdd"),
    dashStatus: el("dashStatus"),
    count: el("count"),
    lastUpdated: el("lastUpdated"),
    tbody: el("tbody"),

    backdrop: el("backdrop"),
    mClose: el("mClose"),
    btnCancel: el("btnCancel"),
    btnSave: el("btnSave"),
    mTitle: el("mTitle"),
    mSub: el("mSub"),
    mStatus: el("mStatus"),

    vId: el("vId"),
    vStatus: el("vStatus"),
    vMake: el("vMake"),
    vModel: el("vModel"),
    vYear: el("vYear"),
    vPrice: el("vPrice"),
    vTitle: el("vTitle"),
    vNotes: el("vNotes"),

    files: el("files"),
    galleryGrid: el("galleryGrid"),
    replaceFile: el("replaceFile"),
    uploadLine: el("uploadLine"),

    leadStatusFilter: el("leadStatusFilter"),
    leadStart: el("leadStart"),
    leadEnd: el("leadEnd"),
    btnLeadsRefresh: el("btnLeadsRefresh"),
    btnExportLeads: el("btnExportLeads"),
    leadCount: el("leadCount"),
    leadUpdated: el("leadUpdated"),
    leadBody: el("leadBody"),
    leadStatus: el("leadStatus"),

    toast: el("toast"),
    toastDot: el("toastDot"),
    toastMsg: el("toastMsg"),
  };

  const state = {
    token: null,
    dealerId: null,
    dealerName: null,
    vehicles: [],
    leads: [],
    editing: null,
    demo: false,
    replacingIndex: null,

    // If server signed endpoint is missing, we'll flip this on and use unsigned preset.
    unsignedFallback: false,
  };

  document.addEventListener("DOMContentLoaded", async () => {
    wire();
    await loadConfig();
    restoreSession();
  });

  function wire(){
    ui.btnLogin.addEventListener("click", doLogin);
    ui.btnDemo.addEventListener("click", enterDemo);
    ui.passcode.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });

    ui.btnLogout.addEventListener("click", logout);

    ui.btnRefresh.addEventListener("click", loadVehicles);
    ui.btnAdd.addEventListener("click", ()=>openModal(null));

    ui.q.addEventListener("input", render);
    ui.filterStatus.addEventListener("change", render);
    ui.sort.addEventListener("change", render);

    ui.mClose.addEventListener("click", closeModal);
    ui.btnCancel.addEventListener("click", closeModal);
    ui.backdrop.addEventListener("click", (e)=>{ if(e.target===ui.backdrop) closeModal(); });

    ui.btnSave.addEventListener("click", saveVehicleAndUpload);
    ui.files.addEventListener("change", handleNewFiles);
    ui.replaceFile.addEventListener("change", handleReplaceFile);

    ui.btnLeadsRefresh.addEventListener("click", loadLeads);
    ui.btnExportLeads.addEventListener("click", exportLeads);
    ui.leadStatusFilter.addEventListener("change", renderLeads);
    ui.leadStart.addEventListener("change", renderLeads);
    ui.leadEnd.addEventListener("change", renderLeads);
  }

  async function loadConfig(){
    try{
      const res = await fetch(API.config(), { headers:{ "Accept":"application/json" } });
      const data = await res.json().catch(()=>null);
      if(!res.ok || !data || data.ok !== true) throw new Error("config load failed");

      CLOUD.cloudName = data.cloudinary?.cloudName || "";
      CLOUD.uploadPreset = data.cloudinary?.uploadPreset || "";
      CLOUD.baseFolder = data.cloudinary?.baseFolder || "mediaexclusive";

      if(!CLOUD.cloudName){
        ui.cfgLine.textContent = "Media storage is not configured. Please contact support.";
        ui.cfgLine.classList.add("error");
      } else if(!CLOUD.uploadPreset){
        // Signed uploads don't require upload preset, but fallback unsigned does.
        ui.cfgLine.textContent = `Media storage connected · folder: ${CLOUD.baseFolder}`;
      } else {
        ui.cfgLine.textContent = `Media storage connected · folder: ${CLOUD.baseFolder}`;
      }
    }catch{
      ui.cfgLine.textContent = "Unable to verify media storage. Please refresh or contact support.";
      ui.cfgLine.classList.add("error");
    }
  }

  function restoreSession(){
    const token = localStorage.getItem("dealer_token");
    const dealerId = localStorage.getItem("dealer_id");
    const dealerName = localStorage.getItem("dealer_name");
    if(token && dealerId){
      state.token = token;
      state.dealerId = dealerId;
      state.dealerName = dealerName || dealerId;
      state.demo = false;
      setApi("Live", "on");
      enterDashboard();
    } else {
      setApi("Offline", "err");
      ui.btnLogout.disabled = true;
    }
  }

  async function doLogin(){
    const dealerId = (ui.dealerId.value || "").trim().toUpperCase();
    const passcode = (ui.passcode.value || "").trim();
    if(!dealerId || !passcode){
      setLoginStatus("Enter Dealer ID + passcode.", true);
      return;
    }
    if(!isValidDealerId(dealerId)){
      setLoginStatus("Dealer ID must be two letters followed by three numbers.", true);
      return;
    }
    setLoginStatus("Signing in…", false);

    try{
      const res = await fetch(API.login(), {
        method:"POST",
        headers:{ "Content-Type":"application/json", "Accept":"application/json" },
        body: JSON.stringify({ dealerId, passcode })
      });
      const data = await res.json().catch(()=>null);
      if(!res.ok || !data || data.ok !== true) throw new Error(data?.error || "Login failed");

      state.token = data.token;
      state.dealerId = data.dealerId || dealerId;
      state.dealerName = data.dealerName || dealerId;
      state.demo = false;

      localStorage.setItem("dealer_token", state.token);
      localStorage.setItem("dealer_id", state.dealerId);
      localStorage.setItem("dealer_name", state.dealerName);

      setApi("Live", "on");
      enterDashboard();
      toast("Signed in.", "success");
    }catch(e){
      setLoginStatus(String(e?.message || "Login failed"), true);
      setApi("Error", "err");
      toast("Login failed.", "error");
    }
  }

  function enterDemo(){
    state.demo = true;
    state.token = "demo-token";
    state.dealerId = "AA123";
    state.dealerName = "Demo Dealer";
    state.vehicles = demoVehicles();
    setApi("Demo", "off");
    enterDashboard();
    render();
    toast("Demo mode.", "success");
  }

  function logout(){
    state.token = null;
    state.dealerId = null;
    state.dealerName = null;
    state.vehicles = [];
    state.leads = [];
    state.demo = false;
    state.unsignedFallback = false;

    localStorage.removeItem("dealer_token");
    localStorage.removeItem("dealer_id");
    localStorage.removeItem("dealer_name");

    ui.dashView.classList.add("hidden");
    ui.loginView.classList.remove("hidden");
    ui.btnLogout.disabled = true;
    ui.topTitle.textContent = "Dealer Portal";
    ui.topSub.textContent = "Log in to manage inventory + photos.";
    ui.storefrontLink.href = "/storefront";
    setLoginStatus("", false);
    setApi("Offline", "err");
    toast("Logged out.", "success");
  }

  function enterDashboard(){
    ui.loginView.classList.add("hidden");
    ui.dashView.classList.remove("hidden");
    ui.btnLogout.disabled = false;

    ui.topTitle.textContent = state.dealerName || "Dealer Portal";
    ui.topSub.textContent = `${state.dealerId || ""} · inventory & media`;
    if(state.dealerId){
      ui.storefrontLink.href = `/storefront/${encodeURIComponent(state.dealerId)}`;
    }
    loadVehicles();
    loadLeads();
  }

  async function loadVehicles(){
    ui.dashStatus.textContent = state.demo ? "Demo inventory loaded." : "Loading vehicles…";
    if(state.demo){
      ui.lastUpdated.textContent = "Updated: " + fmt(new Date());
      updateKpis();
      render();
      return;
    }

    try{
      const res = await fetch(API.vehicles(), {
        headers:{
          "Accept":"application/json",
          "Authorization":"Bearer " + state.token
        }
      });
      const data = await res.json().catch(()=>null);
      if(!res.ok || !data || data.ok !== true) throw new Error(data?.error || "Failed to load");

      state.vehicles = normalize(data.vehicles || []);
      ui.dashStatus.textContent = "Ready.";
      ui.lastUpdated.textContent = "Updated: " + fmt(new Date());
      setApi("Live", "on");
      updateKpis();
      render();
    }catch(e){
      ui.dashStatus.textContent = String(e?.message || "Could not load vehicles.");
      setApi("Error", "err");
      toast("Failed to load inventory.", "error");
    }
  }

  async function loadLeads(){
    ui.leadStatus.textContent = state.demo ? "Demo requests loaded." : "Loading requests…";
    if(state.demo){
      state.leads = demoLeads();
      ui.leadUpdated.textContent = "Updated: " + fmt(new Date());
      updateKpis();
      renderLeads();
      return;
    }

    try{
      const res = await fetch(API.leads(), {
        headers:{
          "Accept":"application/json",
          "Authorization":"Bearer " + state.token
        }
      });
      const data = await res.json().catch(()=>null);
      if(!res.ok || !data || data.ok !== true) throw new Error(data?.error || "Failed to load leads");

      state.leads = Array.isArray(data.leads) ? data.leads : [];
      ui.leadStatus.textContent = "Ready.";
      ui.leadUpdated.textContent = "Updated: " + fmt(new Date());
      updateKpis();
      renderLeads();
    }catch(e){
      ui.leadStatus.textContent = String(e?.message || "Could not load leads.");
      toast("Failed to load leads.", "error");
    }
  }

  function updateKpis(){
    const total = state.vehicles.length;
    const available = state.vehicles.filter(v => v.status === "available").length;
    const pending = state.vehicles.filter(v => v.status === "pending").length;
    const sold = state.vehicles.filter(v => v.status === "sold").length;

    const totalLeads = state.leads.length;
    const booked = state.leads.filter(l => (l.status||"").toLowerCase() === "booked").length;

    const today = new Date();
    const todayKey = today.toISOString().slice(0, 10);
    const newToday = state.leads.filter(l => String(l.createdAt || "").slice(0,10) === todayKey).length;

    ui.kTotal.textContent = String(total);
    ui.kAvailable.textContent = String(available);
    ui.kPending.textContent = String(pending);
    ui.kSold.textContent = String(sold);
    ui.kRequests.textContent = String(totalLeads);
    ui.kNewToday.textContent = String(newToday);
    ui.kBooked.textContent = String(booked);
  }

  function render(){
    const q = (ui.q.value || "").trim().toLowerCase();
    const fs = (ui.filterStatus.value || "").trim().toLowerCase();
    const sort = ui.sort.value || "newest";

    let list = [...state.vehicles];

    if(q) list = list.filter(v => blob(v).includes(q));
    if(fs) list = list.filter(v => (String(v.status||"available").toLowerCase() === fs));

    list.sort((a,b)=>{
      if(sort==="priceAsc") return (a.price||0)-(b.price||0);
      if(sort==="priceDesc") return (b.price||0)-(a.price||0);
      if(sort==="yearAsc") return (a.year||0)-(b.year||0);
      if(sort==="yearDesc") return (b.year||0)-(a.year||0);
      return new Date(b.updatedAt || b.createdAt || 0).getTime() - new Date(a.updatedAt || a.createdAt || 0).getTime();
    });

    ui.tbody.innerHTML = "";
    ui.count.textContent = String(list.length);

    if(!list.length){
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 5;
      td.style.color = "var(--muted)";
      td.style.padding = "14px";
      td.textContent = "No vehicles match your filters.";
      tr.appendChild(td);
      ui.tbody.appendChild(tr);
      return;
    }

    list.forEach(v=>{
      const tr = document.createElement("tr");
      tr.addEventListener("click", ()=>openModal(v));

      const td1 = document.createElement("td");
      td1.innerHTML = `<div class="mono">${esc(v.vehicleId)}</div>
                       <div style="color:var(--muted);font-size:11px;margin-top:2px">${esc(v.make)} ${esc(v.model)}</div>`;

      const td2 = document.createElement("td");
      td2.innerHTML = `<div>${esc(v.year?String(v.year):"—")}</div>
                       <div style="color:var(--muted);font-size:11px;margin-top:2px">${esc(v.title||"")}</div>`;

      const td3 = document.createElement("td");
      const s = String(v.status||"available").toLowerCase();
      td3.innerHTML = `<span class="tag ${esc(s)}">${esc(s)}</span>`;

      const td4 = document.createElement("td");
      td4.innerHTML = `<div style="font-weight:900">${money(v.price)}</div>`;

      const td5 = document.createElement("td");
      const hero = v.heroImage || (Array.isArray(v.images) ? v.images[0] : "");
      td5.innerHTML = hero
        ? `<img class="thumb" src="${esc(hero)}" alt="Vehicle thumbnail" referrerpolicy="no-referrer" />
           <div style="color:var(--muted);font-size:11px;margin-top:4px">${(v.images||[]).length} photos</div>`
        : `<div>${(v.images||[]).length} photos</div>
           <div style="color:var(--muted);font-size:11px;margin-top:2px">${v.heroImage ? "Hero set" : "No hero"}</div>`;

      tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4); tr.appendChild(td5);
      ui.tbody.appendChild(tr);
    });
  }

  function getFilteredLeads(){
    const status = (ui.leadStatusFilter.value || "").toLowerCase();
    const start = ui.leadStart.value ? new Date(ui.leadStart.value) : null;
    const end = ui.leadEnd.value ? new Date(ui.leadEnd.value) : null;

    return state.leads.filter((l) => {
      if(status && String(l.status || "").toLowerCase() !== status) return false;
      if(start || end){
        const created = l.createdAt ? new Date(l.createdAt) : null;
        if(start && created && created < start) return false;
        if(end && created && created > new Date(end.getTime() + 86400000)) return false;
      }
      return true;
    });
  }

  function renderLeads(){
    const list = getFilteredLeads();
    ui.leadBody.innerHTML = "";
    ui.leadCount.textContent = String(list.length);

    if(!list.length){
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 6;
      td.style.color = "var(--muted)";
      td.style.padding = "14px";
      td.textContent = "No requests match your filters.";
      tr.appendChild(td);
      ui.leadBody.appendChild(tr);
      return;
    }

    list.forEach((l) => {
      const tr = document.createElement("tr");

      tr.appendChild(cell(`<div style="font-weight:900">${esc(l.name || "—")}</div><div style="color:var(--muted);font-size:11px;margin-top:2px">${esc(l.phone || "")}</div>`));
      tr.appendChild(cell(`<div class="mono">${esc(l.vehicleId || "—")}</div>`));
      tr.appendChild(cell(`<span class="tag ${esc((l.type || "lead").toLowerCase())}">${esc(l.type || "lead")}</span>`));
      tr.appendChild(cell(`<span class="tag ${esc((l.status || "new").toLowerCase())}">${esc(l.status || "new")}</span>`));
      tr.appendChild(cell(`<span class="mono">${esc(l.createdAt || "")}</span>`));

      const actions = document.createElement("td");
      const bookedBtn = document.createElement("button");
      bookedBtn.className = "btn btn-mini";
      bookedBtn.textContent = "Mark booked";
      bookedBtn.disabled = String(l.status || "").toLowerCase() === "booked";
      bookedBtn.onclick = () => updateLeadStatus(l.leadId, "booked");

      const closedBtn = document.createElement("button");
      closedBtn.className = "btn btn-mini";
      closedBtn.textContent = "Close";
      closedBtn.disabled = String(l.status || "").toLowerCase() === "closed";
      closedBtn.onclick = () => updateLeadStatus(l.leadId, "closed");

      actions.appendChild(bookedBtn);
      actions.appendChild(closedBtn);
      tr.appendChild(actions);

      ui.leadBody.appendChild(tr);
    });
  }

  async function updateLeadStatus(leadId, status){
    if(!leadId || !status) return;
    ui.leadStatus.textContent = "Updating status…";

    try{
      if(state.demo){
        const idx = state.leads.findIndex(l => l.leadId === leadId);
        if(idx > -1) state.leads[idx].status = status;
        ui.leadStatus.textContent = "Status updated (demo).";
        updateKpis();
        renderLeads();
        return;
      }

      const res = await fetch(API.leadStatus(), {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Accept":"application/json",
          "Authorization":"Bearer " + state.token
        },
        body: JSON.stringify({ leadId, status })
      });
      const data = await res.json().catch(()=>null);
      if(!res.ok || !data || data.ok !== true) throw new Error(data?.error || "Status update failed");

      const idx = state.leads.findIndex(l => l.leadId === leadId);
      if(idx > -1) state.leads[idx] = { ...state.leads[idx], status };
      ui.leadStatus.textContent = "Status updated.";
      updateKpis();
      renderLeads();
    }catch(e){
      ui.leadStatus.textContent = "Failed to update status.";
      toast("Status update failed.", "error");
    }
  }

  function exportLeads(){
    const list = getFilteredLeads();
    if(!list.length){
      toast("No requests to export.", "error");
      return;
    }
    const headers = ["createdAt","leadId","vehicleId","type","name","phone","email","preferredDate","preferredTime","notes","source","status"];
    const rows = list.map(l => headers.map(h => String(l[h] ?? "")));
    const csv = [headers.join(","), ...rows.map(r => r.map(v => `"${v.replaceAll('"','""')}"`).join(","))].join("\n");
    const blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${state.dealerId || "dealer"}_leads.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function openModal(v){
    state.editing = v ? deepClone(v) : null;
    ui.mTitle.textContent = v ? "Edit vehicle" : "Add vehicle";
    ui.mStatus.textContent = "";
    ui.mStatus.classList.remove("error");
    ui.uploadLine.textContent = "";

    ui.vId.value = v?.vehicleId || "";
    ui.vStatus.value = (v?.status || "available").toLowerCase();
    ui.vMake.value = v?.make || "";
    ui.vModel.value = v?.model || "";
    ui.vYear.value = v?.year || "";
    ui.vPrice.value = v?.price || "";
    ui.vTitle.value = v?.title || "";
    ui.vNotes.value = v?.notes || "";
    ui.files.value = "";
    ui.replaceFile.value = "";
    state.replacingIndex = null;

    if(!state.editing){
      state.editing = {
        images: [],
        heroImage: ""
      };
    }
    if(!Array.isArray(state.editing.images)) state.editing.images = [];
    renderGallery();
    ui.backdrop.classList.add("show");
    ui.backdrop.setAttribute("aria-hidden","false");
  }

  function closeModal(){
    ui.backdrop.classList.remove("show");
    ui.backdrop.setAttribute("aria-hidden","true");
    state.editing = null;
  }

  function renderGallery(){
    ui.galleryGrid.innerHTML = "";
    const images = Array.isArray(state.editing?.images) ? state.editing.images : [];
    if(images.length && !state.editing.heroImage){
      state.editing.heroImage = images[0];
    }
    if(!images.length){
      const empty = document.createElement("div");
      empty.className = "hint";
      empty.textContent = "No images yet. Upload up to 7 photos.";
      ui.galleryGrid.appendChild(empty);
      return;
    }

    images.forEach((url, index) => {
      const item = document.createElement("div");
      item.className = "galleryItem";

      const img = document.createElement("img");
      img.src = url;
      img.alt = `Vehicle image ${index + 1}`;
      img.referrerPolicy = "no-referrer";
      img.loading = "lazy";

      const actions = document.createElement("div");
      actions.className = "galleryActions";

      const heroBtn = document.createElement("button");
      heroBtn.className = "btn btn-mini";
      heroBtn.textContent = state.editing.heroImage === url ? "Hero ✓" : "Set hero";
      heroBtn.onclick = () => {
        state.editing.heroImage = url;
        renderGallery();
      };

      const replaceBtn = document.createElement("button");
      replaceBtn.className = "btn btn-mini";
      replaceBtn.textContent = "Replace";
      replaceBtn.onclick = () => {
        state.replacingIndex = index;
        ui.replaceFile.click();
      };

      const removeBtn = document.createElement("button");
      removeBtn.className = "btn btn-mini";
      removeBtn.textContent = "Remove";
      removeBtn.onclick = () => {
        state.editing.images.splice(index, 1);
        if(state.editing.heroImage === url){
          state.editing.heroImage = state.editing.images[0] || "";
        }
        renderGallery();
      };

      actions.appendChild(heroBtn);
      actions.appendChild(replaceBtn);
      actions.appendChild(removeBtn);

      item.appendChild(img);
      item.appendChild(actions);
      ui.galleryGrid.appendChild(item);
    });
  }

  function handleNewFiles(){
    const existingCount = Array.isArray(state.editing?.images) ? state.editing.images.length : 0;
    const newFiles = ui.files.files ? Array.from(ui.files.files) : [];
    const total = existingCount + newFiles.length;
    if(total > 7){
      setMStatus("You can upload up to 7 images per vehicle.", true);
    } else {
      setMStatus("", false);
    }
  }

  async function handleReplaceFile(){
    const file = ui.replaceFile.files && ui.replaceFile.files[0];
    if(!file || state.replacingIndex == null) return;
    if(state.demo){
      state.editing.images[state.replacingIndex] = URL.createObjectURL(file);
      state.replacingIndex = null;
      ui.replaceFile.value = "";
      renderGallery();
      return;
    }

    const vehicleId = (ui.vId.value || "").trim();
    if(!vehicleId && !state.editing?.vehicleId){
      setMStatus("Save the vehicle first to replace images.", true);
      ui.replaceFile.value = "";
      state.replacingIndex = null;
      return;
    }

    try{
      ui.uploadLine.textContent = "Replacing image…";
      const signer = await getCloudinarySigner(vehicleId || state.editing.vehicleId);
      const url = await uploadOneToCloudinary(file, signer);
      state.editing.images[state.replacingIndex] = url;
      if(!state.editing.heroImage){
        state.editing.heroImage = url;
      }
      ui.uploadLine.textContent = "Image replaced.";
      renderGallery();
    }catch(e){
      ui.uploadLine.textContent = "Replace failed.";
      toast("Replace failed.", "error");
    }finally{
      ui.replaceFile.value = "";
      state.replacingIndex = null;
    }
  }

  // ✅ Main flow:
  // 1) Save vehicle first -> ensures vehicleId exists in Sheets
  // 2) Request SIGNED upload params from server (recommended)
  // 3) Upload images to Cloudinary -> get secure_url
  // 4) Merge images, set hero automatically (or chosen), save again -> Sheets/storefront updated
  async function saveVehicleAndUpload(){
    const payload = buildPayload();
    if(!payload.make || !payload.model){
      setMStatus("Make + Model are required.", true);
      return;
    }
    if(!CLOUD.cloudName){
      setMStatus("Media storage is not configured. Contact support.", true);
      return;
    }
    if(!state.demo && !state.token){
      setMStatus("Not logged in.", true);
      return;
    }

    const newFiles = ui.files.files ? Array.from(ui.files.files) : [];
    const existingImages = Array.isArray(payload.images) ? payload.images : [];
    if(existingImages.length + newFiles.length > 7){
      setMStatus("Maximum 7 images allowed per vehicle.", true);
      return;
    }

    ui.btnSave.disabled = true;
    ui.uploadLine.textContent = "";
    setMStatus("Saving…", false);

    try{
      // (1) Save first (vehicleId generated server-side if blank)
      const savedBase = await saveVehicle({
        vehicleId: payload.vehicleId || "",
        title: payload.title,
        make: payload.make,
        model: payload.model,
        year: payload.year,
        price: payload.price,
        status: payload.status,
        notes: payload.notes,
        images: existingImages,
        heroImage: payload.heroImage || "",
      });

      let uploadedUrls = [];

      if(newFiles.length && !state.demo){
        ui.uploadLine.textContent = `Uploading ${newFiles.length} photo(s)…`;

        // (2) Ask server for signed upload params (recommended)
        // If endpoint not available, fallback to unsigned preset upload (needs CLOUDINARY_UPLOAD_PRESET)
        const signer = await getCloudinarySigner(savedBase.vehicleId);

        // (3) Upload
        uploadedUrls = await uploadFilesToCloudinary(savedBase.vehicleId, newFiles, signer);
      }

      const mergedImages = [...existingImages, ...uploadedUrls].filter(Boolean).slice(0, 7);

      // (4) Hero selection + auto
      let heroImage = payload.heroImage || "";
      if(heroImage && !mergedImages.includes(heroImage)) heroImage = "";
      if(!heroImage) heroImage = mergedImages[0] || "";

      // Save final URLs to Sheets
      await saveVehicle({
        vehicleId: savedBase.vehicleId,
        title: payload.title,
        make: payload.make,
        model: payload.model,
        year: payload.year,
        price: payload.price,
        status: payload.status,
        notes: payload.notes,
        images: mergedImages,
        heroImage: heroImage
      });

      state.editing.images = mergedImages;
      state.editing.heroImage = heroImage;
      toast(newFiles.length ? "Vehicle saved + photos uploaded." : "Vehicle saved.", "success");
      closeModal();
      await loadVehicles();
    }catch(e){
      setMStatus(String(e?.message || "Save failed."), true);
      toast("Save failed.", "error");
    }finally{
      ui.btnSave.disabled = false;
    }
  }

  function buildPayload(){
    const vehicleId = (ui.vId.value || "").trim();
    return {
      vehicleId: vehicleId || "",
      status: (ui.vStatus.value || "available").toLowerCase(),
      make: (ui.vMake.value || "").trim(),
      model: (ui.vModel.value || "").trim(),
      year: numOrNull(ui.vYear.value),
      price: num(ui.vPrice.value),
      title: (ui.vTitle.value || "").trim(),
      notes: (ui.vNotes.value || "").trim(),
      images: Array.isArray(state.editing?.images) ? state.editing.images : [],
      heroImage: (state.editing?.heroImage || "")
    };
  }

  async function saveVehicle(payload){
    if(state.demo){
      const id = payload.vehicleId || genVehicleId();
      const merged = {
        ...payload,
        vehicleId: id,
        dealerId: state.dealerId,
        updatedAt: new Date().toISOString()
      };
      const idx = state.vehicles.findIndex(x=>x.vehicleId===id);
      if(idx>-1) state.vehicles[idx] = { ...state.vehicles[idx], ...merged };
      else state.vehicles.unshift(merged);
      return merged;
    }

    const res = await fetch(API.vehicles(), {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Accept":"application/json",
        "Authorization":"Bearer " + state.token
      },
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(()=>null);
    if(!res.ok || !data || data.ok !== true) throw new Error(data?.error || "Vehicle save failed");
    return normalize([data.vehicle])[0];
  }

  // -----------------------------
  // SIGNED UPLOAD SUPPORT
  // -----------------------------

  // Returns a "signer" object used by upload calls.
  // signer.mode: "signed" | "unsigned"
  // signed => { apiKey, timestamp, signature, folder }
  // unsigned => { uploadPreset, folder }
  async function getCloudinarySigner(vehicleId){
    // If we've already decided signed endpoint isn't there, skip trying again.
    if(state.unsignedFallback){
      if(!CLOUD.uploadPreset) throw new Error("Standard upload preset is missing. Contact support.");
      return { mode:"unsigned", uploadPreset: CLOUD.uploadPreset, folder: makeFolder(vehicleId) };
    }

    try{
      const folder = makeFolder(vehicleId);

      const res = await fetch(API.cloudinarySign(), {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Accept":"application/json",
          "Authorization":"Bearer " + state.token
        },
        body: JSON.stringify({
          folder,
          // you can also send other upload params that the server should sign:
          // eager, tags, context, etc
        })
      });

      // If endpoint isn't there yet, Cloud Run will typically return 404
      if(res.status === 404){
        state.unsignedFallback = true;
        if(!CLOUD.uploadPreset) {
          throw new Error("Secure upload is unavailable and standard upload is not configured.");
        }
        ui.uploadLine.textContent = "Secure upload unavailable — using standard upload.";
        return { mode:"unsigned", uploadPreset: CLOUD.uploadPreset, folder };
      }

      const data = await res.json().catch(()=>null);
      if(!res.ok || !data || data.ok !== true) throw new Error(data?.error || "Could not get signed upload params");

      // Expected fields
      const apiKey = data.apiKey || data.cloudinaryApiKey || "";
      const timestamp = data.timestamp;
      const signature = data.signature || "";
      const signedFolder = data.folder || folder;

      if(!apiKey || !timestamp || !signature) throw new Error("Signed upload params incomplete (apiKey/timestamp/signature).");

      return {
        mode: "signed",
        apiKey,
        timestamp,
        signature,
        folder: signedFolder,
      };
    }catch(err){
      // Fallback to unsigned preset if possible
      if(CLOUD.uploadPreset){
        state.unsignedFallback = true;
        ui.uploadLine.textContent = "Secure upload failed — using standard upload.";
        return { mode:"unsigned", uploadPreset: CLOUD.uploadPreset, folder: makeFolder(vehicleId) };
      }
      // If no fallback, bubble error
      throw err;
    }
  }

  function makeFolder(vehicleId){
    // Folder strategy: baseFolder/dealers/<dealerId>/vehicles/<vehicleId>
    return `${CLOUD.baseFolder}/dealers/${state.dealerId}/vehicles/${vehicleId}`;
  }

  async function uploadOneToCloudinary(file, signer){
    const url = `https://api.cloudinary.com/v1_1/${encodeURIComponent(CLOUD.cloudName)}/image/upload`;
    const fd = new FormData();
    fd.append("file", file);

    // Always set folder (either signed or unsigned)
    fd.append("folder", signer.folder);

    if(signer.mode === "signed"){
      fd.append("api_key", signer.apiKey);
      fd.append("timestamp", String(signer.timestamp));
      fd.append("signature", signer.signature);
      // (Optional) keep filename behavior consistent
      // fd.append("use_filename", "true");
      // fd.append("unique_filename", "true");
    } else {
      // unsigned
      fd.append("upload_preset", signer.uploadPreset);
    }

    const res = await fetch(url, { method:"POST", body: fd });
    const json = await res.json().catch(()=>null);

    if(!res.ok){
      const msg = json?.error?.message || `Cloudinary upload failed (${res.status})`;
      throw new Error(msg);
    }

    // ✅ secure_url is what we store into Sheets
    return json.secure_url || json.url;
  }

  async function uploadFilesToCloudinary(vehicleId, files, signer){
    const out = [];
    for(let i=0;i<files.length;i++){
      const f = files[i];
      ui.uploadLine.textContent = `Uploading ${i+1}/${files.length}: ${f.name}`;
      const secureUrl = await uploadOneToCloudinary(f, signer);
      out.push(secureUrl);
    }
    ui.uploadLine.textContent = `Uploaded ${out.length}/${files.length}.`;
    return out;
  }

  function setApi(text, mode){
    ui.apiText.textContent = text || "—";
    ui.apiDot.classList.remove("on","err");
    if(mode==="on") ui.apiDot.classList.add("on");
    if(mode==="err") ui.apiDot.classList.add("err");
  }
  function setLoginStatus(msg, err){
    ui.loginStatus.textContent = msg || "";
    ui.loginStatus.classList.toggle("error", !!err);
  }
  function setMStatus(msg, err){
    ui.mStatus.textContent = msg || "";
    ui.mStatus.classList.toggle("error", !!err);
  }
  function toast(message, type){
    ui.toastMsg.textContent = message || "";
    ui.toast.classList.remove("success","error");
    if(type==="success"){ ui.toast.classList.add("success"); ui.toastDot.style.background="#22c55e"; }
    else if(type==="error"){ ui.toast.classList.add("error"); ui.toastDot.style.background="#fb7185"; }
    else ui.toastDot.style.background="var(--brand)";
    ui.toast.classList.add("show");
    clearTimeout(window.__t);
    window.__t = setTimeout(()=>ui.toast.classList.remove("show"), 3200);
  }

  function cell(html){
    const td = document.createElement("td");
    td.innerHTML = html;
    return td;
  }

  function normalize(list){
    return (list||[]).map(v => ({
      vehicleId: v.vehicleId || genVehicleId(),
      dealerId: v.dealerId || state.dealerId,
      title: v.title || "",
      make: v.make || "",
      model: v.model || "",
      year: (v.year!=null && v.year!=="") ? Number(v.year) : null,
      price: Number(v.price||0) || 0,
      status: (v.status || "available").toLowerCase(),
      notes: v.notes || "",
      heroImage: v.heroImage || "",
      images: Array.isArray(v.images) ? v.images : [],
      updatedAt: v.updatedAt || v.createdAt || new Date().toISOString(),
      createdAt: v.createdAt || v.updatedAt || new Date().toISOString()
    }));
  }

  function demoVehicles(){
    return normalize([
      { vehicleId:"VEH-10021", make:"Toyota", model:"Vitz", year:2018, price:1250000, status:"available", notes:"Clean unit.", images:["https://example.com/a.jpg","https://example.com/b.jpg"], heroImage:"https://example.com/a.jpg" },
      { vehicleId:"VEH-10022", make:"Honda", model:"Civic", year:2017, price:2200000, status:"pending", notes:"Pending deposit.", images:["https://example.com/c.jpg"] },
    ]);
  }

  function demoLeads(){
    return [
      { createdAt: new Date().toISOString(), leadId:"lead_demo_1", vehicleId:"VEH-10021", type:"live_video", name:"Andre W.", phone:"876-555-0192", email:"", preferredDate:"", preferredTime:"", notes:"Need quick tour", source:"storefront", status:"new" },
      { createdAt: new Date(Date.now()-3600*1000*10).toISOString(), leadId:"lead_demo_2", vehicleId:"VEH-10022", type:"walk_in", name:"Kiera M.", phone:"876-555-0113", email:"", preferredDate:"", preferredTime:"", notes:"Book afternoon slot", source:"storefront", status:"booked" },
    ];
  }

  function blob(v){
    return [v.vehicleId,v.title,v.make,v.model,v.year,v.notes]
      .filter(Boolean).join(" ").toLowerCase();
  }
  function money(n){
    const v = Number(n);
    if(!Number.isFinite(v) || v<=0) return "Price on request";
    return "JMD " + v.toLocaleString(undefined,{maximumFractionDigits:0});
  }
  function fmt(d){
    const dt = (d instanceof Date)?d:new Date(d);
    const day = String(dt.getDate()).padStart(2,"0");
    const mon = String(dt.getMonth()+1).padStart(2,"0");
    const yr = String(dt.getFullYear()).slice(-2);
    const hr = String(dt.getHours()).padStart(2,"0");
    const mi = String(dt.getMinutes()).padStart(2,"0");
    return `${day}/${mon}/${yr} ${hr}:${mi}`;
  }
  function num(v){
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }
  function numOrNull(v){
    if(v === "" || v == null) return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }
  function isValidDealerId(v){
    return /^[A-Za-z]{2}\d{3}$/.test(String(v || "").trim());
  }
  function genVehicleId(){
    return "VEH-" + Math.random().toString(16).slice(2,8).toUpperCase();
  }
  function deepClone(x){ return JSON.parse(JSON.stringify(x||null)); }
  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");
  }
</script>
</body>
</html>
