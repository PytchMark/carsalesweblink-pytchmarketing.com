<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Carsales — Dealer Portal</title>

  <style>
    :root{
      /* White + Red (modern SaaS) */
      --bg:#f7f7fb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --muted2:#94a3b8;

      --red:#ef4444;
      --red2:#dc2626;
      --redSoft:rgba(239,68,68,.10);

      --line:#e5e7eb;
      --line2:#eef2f7;

      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;

      --shadow: 0 18px 45px rgba(2,6,23,.08);
      --shadow2: 0 10px 24px rgba(2,6,23,.06);

      --radius:18px;
      --radius2:22px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(circle at 15% 0%, rgba(239,68,68,.10) 0, transparent 35%),
        radial-gradient(circle at 85% 10%, rgba(239,68,68,.08) 0, transparent 40%),
        var(--bg);
      -webkit-font-smoothing:antialiased;
    }
    a{color:inherit;text-decoration:none}
    .hidden{display:none!important}

    /* Layout */
    .wrap{min-height:100%; display:flex; justify-content:center; padding:18px}
    .shell{width:100%; max-width:1200px; display:flex; flex-direction:column; gap:12px}

    /* Topbar */
    .topbar{
      display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between;
      padding:14px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.86));
      border:1px solid var(--line);
      border-radius:24px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; gap:12px; align-items:center}
    .badge{
      width:44px;height:44px;border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;color:#fff;
      background: linear-gradient(135deg, var(--red), var(--red2));
      box-shadow: 0 14px 28px rgba(239,68,68,.22);
    }
    .brand h1{margin:0; font-size:16px; letter-spacing:.01em}
    .brand .sub{margin-top:3px; font-size:12px; color:var(--muted)}
    .right{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow: var(--shadow2);
      font-size:12px;
      color:var(--muted);
    }
    .dot{
      width:9px;height:9px;border-radius:999px;
      background: var(--warn);
      box-shadow: 0 0 0 4px rgba(245,158,11,.16);
    }
    .dot.on{background:var(--good); box-shadow: 0 0 0 4px rgba(22,163,74,.14)}
    .dot.err{background:var(--bad); box-shadow: 0 0 0 4px rgba(239,68,68,.14)}

    .btn{
      border:1px solid transparent;
      cursor:pointer;
      border-radius:999px;
      padding:9px 13px;
      font-size:12px;
      font-weight:700;
      display:inline-flex; align-items:center; gap:8px;
      background:#fff;
      color:var(--ink);
      box-shadow: var(--shadow2);
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); box-shadow: 0 14px 28px rgba(2,6,23,.08)}
    .btn:active{transform: translateY(0px)}
    .btn-ghost{border-color: var(--line); background:#fff; color:var(--ink)}
    .btn-primary{
      background: linear-gradient(135deg, var(--red), var(--red2));
      color:#fff;
      border-color: rgba(0,0,0,.06);
      box-shadow: 0 18px 34px rgba(239,68,68,.20);
    }
    .btn-primary:hover{box-shadow: 0 22px 46px rgba(239,68,68,.26)}
    .btn:disabled{opacity:.6; cursor:not-allowed; transform:none}

    /* Cards / panels */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media(min-width:980px){
      .grid{grid-template-columns: 0.42fr 0.58fr}
    }
    .panel{
      background: rgba(255,255,255,.95);
      border:1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .panel h3{margin:0 0 6px; font-size:13px; letter-spacing:.02em}
    .hint{font-size:12px; color:var(--muted); line-height:1.35}

    /* Fields */
    .field{margin-top:10px}
    .label{
      display:flex; justify-content:space-between; gap:8px;
      font-size:11px; color:var(--muted);
      margin-bottom:6px;
    }
    .input,.select,.textarea{
      width:100%;
      border-radius: 14px;
      border:1px solid var(--line);
      background:#fff;
      padding:10px 12px;
      font-size:13px;
      color:var(--ink);
      outline:none;
      transition: border-color .15s ease, box-shadow .15s ease, transform .08s ease;
    }
    .input:focus,.select:focus,.textarea:focus{
      border-color: rgba(239,68,68,.65);
      box-shadow: 0 0 0 4px rgba(239,68,68,.12);
      transform: translateY(-1px);
    }
    .textarea{min-height:90px; resize:vertical}

    .row{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media(min-width:560px){ .row.two{grid-template-columns: 1fr 1fr} }
    @media(min-width:860px){ .row.three{grid-template-columns: 1fr 1fr 1fr} }

    /* Table */
    .table-shell{
      overflow:hidden;
      border-radius: var(--radius2);
      border:1px solid var(--line);
      background:#fff;
      box-shadow: var(--shadow);
    }
    .table-head{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:12px 14px;
      border-bottom:1px solid var(--line2);
      background: linear-gradient(180deg, rgba(239,68,68,.08), rgba(255,255,255,1));
    }
    .table-title{font-size:13px; font-weight:850}
    .table-meta{font-size:11px; color:var(--muted)}
    .scroll{max-height:560px; overflow:auto}
    table{width:100%; border-collapse:collapse; font-size:12px}
    thead{position:sticky; top:0; background:#fff; z-index:1}
    th,td{padding:10px 12px; text-align:left; border-bottom:1px solid var(--line2)}
    th{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:var(--muted2);
      background:#fff;
    }
    tbody tr{transition: background .12s ease}
    tbody tr:hover{background: rgba(239,68,68,.06)}
    .mono{font-family:var(--mono); font-size:11px}

    .status{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px; border-radius:999px;
      font-size:10px; letter-spacing:.08em; text-transform:uppercase;
      border:1px solid transparent;
      font-weight:800;
    }
    .available{background: rgba(22,163,74,.10); color:#166534; border-color: rgba(22,163,74,.26)}
    .pending{background: rgba(245,158,11,.12); color:#92400e; border-color: rgba(245,158,11,.28)}
    .sold{background: rgba(239,68,68,.12); color:#7f1d1d; border-color: rgba(239,68,68,.25)}
    .published{background: rgba(59,130,246,.10); color:#1e3a8a; border-color: rgba(59,130,246,.25)}

    .chip{
      display:inline-flex; align-items:center;
      border-radius:999px;
      padding:4px 8px;
      border:1px solid var(--line);
      color:var(--muted);
      background:#fff;
      font-size:11px;
    }

    /* Modal */
    .backdrop{
      position:fixed; inset:0; z-index:50;
      background: rgba(2,6,23,.50);
      backdrop-filter: blur(10px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .backdrop.show{display:flex}
    .modal{
      width:100%;
      max-width:900px;
      background:#fff;
      border-radius: 26px;
      border:1px solid rgba(255,255,255,.45);
      box-shadow: 0 36px 90px rgba(2,6,23,.35);
      overflow:hidden;
    }
    .mhead{
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      padding:14px 16px;
      border-bottom:1px solid var(--line2);
      background: linear-gradient(180deg, rgba обучения: rgba(239,68,68,.10), #fff);
    }
    .mhead h3{margin:0; font-size:14px; font-weight:900}
    .msub{font-size:12px; color:var(--muted); margin-top:4px}
    .xbtn{
      border:none;
      background: rgba(2,6,23,.04);
      color: var(--muted);
      width:36px;height:36px;
      border-radius:999px;
      cursor:pointer;
      font-size:20px;
      display:inline-flex; align-items:center; justify-content:center;
    }
    .xbtn:hover{background: rgba(239,68,68,.10); color:#7f1d1d}
    .mbody{padding:14px 16px}

    .uploadBox{
      margin-top:10px;
      border:1px dashed rgba(239,68,68,.35);
      background: rgba(239,68,68,.05);
      border-radius: 18px;
      padding:12px;
    }
    .uploadRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .preview{
      display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;
    }
    .thumb{
      width:72px; height:54px;
      border-radius:12px;
      border:1px solid var(--line);
      overflow:hidden;
      background:#fff;
      box-shadow: var(--shadow2);
      display:flex; align-items:center; justify-content:center;
      font-size:10px; color:var(--muted);
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block}

    .statusline{min-height:18px; font-size:12px; color:var(--muted); margin-top:10px}
    .statusline.error{color: #b91c1c}

    /* Toast */
    #toast{
      position:fixed; bottom:16px; right:16px; z-index:60;
      padding:10px 14px; border-radius:999px; font-size:12px;
      display:none; align-items:center; gap:8px;
      background:#fff;
      border:1px solid var(--line);
      color: var(--muted);
      box-shadow: var(--shadow);
    }
    #toast.show{display:flex}
    #toast.success{border-color: rgba(22,163,74,.30); color:#166534}
    #toast.error{border-color: rgba(239,68,68,.30); color:#7f1d1d}
    #toastDot{width:9px;height:9px;border-radius:999px;background:var(--red)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="shell">

      <!-- LOGIN VIEW -->
      <header class="topbar" id="loginTop">
        <div class="brand">
          <div class="badge">D</div>
          <div>
            <h1>Dealer Portal</h1>
            <div class="sub">Manage inventory, photos, and availability — fast and clean.</div>
          </div>
        </div>
        <div class="right">
          <a class="btn btn-ghost" href="/" title="Back to Storefront">Storefront</a>
        </div>
      </header>

      <section class="panel" id="loginView">
        <h3>Sign in</h3>
        <div class="hint">Use the <b>Dealer ID</b> and the <b>6-digit passcode</b> generated from Admin.</div>

        <div class="row two" style="margin-top:10px">
          <div class="field">
            <div class="label"><span>Dealer ID</span><span>Required</span></div>
            <input id="dealerId" class="input" placeholder="dealerslug (e.g. dealerpytch)" autocomplete="username" />
          </div>
          <div class="field">
            <div class="label"><span>Passcode</span><span>Required</span></div>
            <input id="passcode" class="input" type="password" inputmode="numeric" placeholder="••••••" autocomplete="current-password" />
          </div>
        </div>

        <div style="display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap; margin-top:12px">
          <button class="btn btn-ghost" id="btnDemo" type="button">Demo mode</button>
          <button class="btn btn-primary" id="btnLogin" type="button">Sign in</button>
        </div>

        <div class="statusline" id="loginStatus"></div>
      </section>

      <!-- DASH VIEW -->
      <header class="topbar hidden" id="dashTop">
        <div class="brand">
          <div class="badge">D</div>
          <div>
            <h1 id="dealerTitle">Dealer</h1>
            <div class="sub" id="dealerSub">Inventory manager</div>
          </div>
        </div>

        <div class="right">
          <div class="pill" title="API connection status">
            <span class="dot" id="apiDot"></span>
            <span id="apiStatus">Connecting…</span>
          </div>
          <button class="btn btn-ghost" id="btnRefresh" type="button">Refresh</button>
          <button class="btn btn-primary" id="btnAdd" type="button">Add vehicle</button>
          <a class="btn btn-ghost" href="/" title="Open Storefront">Storefront</a>
          <button class="btn btn-ghost" id="btnLogout" type="button">Logout</button>
        </div>
      </header>

      <section class="grid hidden" id="dashView">
        <div class="panel">
          <h3>Quick actions</h3>
          <div class="hint">
            Tip: set status to <b>Published</b> when a vehicle is ready for customers.
            <br/>Keep entries clean — dropdowns help reduce mistakes.
          </div>

          <div class="field">
            <div class="label"><span>Search inventory</span><span>Vehicle / Make / Model / Notes</span></div>
            <input id="q" class="input" placeholder="Search…" />
          </div>

          <div class="row two">
            <div class="field">
              <div class="label"><span>Status</span><span>Filter</span></div>
              <select id="filterStatus" class="select">
                <option value="">All</option>
                <option value="published">Published</option>
                <option value="available">Available</option>
                <option value="pending">Pending</option>
                <option value="sold">Sold</option>
              </select>
            </div>
            <div class="field">
              <div class="label"><span>Sort</span><span>Default</span></div>
              <select id="sort" class="select">
                <option value="newest">Newest</option>
                <option value="priceAsc">Price: Low → High</option>
                <option value="priceDesc">Price: High → Low</option>
                <option value="yearDesc">Year: New → Old</option>
                <option value="yearAsc">Year: Old → New</option>
              </select>
            </div>
          </div>

          <div class="statusline" id="dashStatus"></div>

          <div class="field" style="margin-top:12px">
            <div class="label"><span>What gets shown publicly?</span><span>Storefront rule</span></div>
            <div class="hint">
              Storefront shows vehicles marked <b>Published</b> (and also “Available” if enabled).
              <br/>If you don’t see vehicles on the storefront, confirm the status and refresh.
            </div>
          </div>
        </div>

        <div class="table-shell">
          <div class="table-head">
            <div>
              <div class="table-title">Your vehicles</div>
              <div class="table-meta">Showing <span id="count">0</span> vehicles</div>
            </div>
            <div class="table-meta" id="lastUpdated">—</div>
          </div>

          <div class="scroll">
            <table>
              <thead>
                <tr>
                  <th>Vehicle</th>
                  <th>Specs</th>
                  <th>Status</th>
                  <th>Price</th>
                  <th>Photos</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>
      </section>

    </div>
  </div>

  <!-- ADD/EDIT MODAL -->
  <div class="backdrop" id="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Vehicle editor">
      <div class="mhead">
        <div>
          <h3 id="mTitle">Add vehicle</h3>
          <div class="msub" id="mSub">Create a listing, then upload photos (fast).</div>
        </div>
        <button class="xbtn" id="mClose" type="button" aria-label="Close">×</button>
      </div>

      <div class="mbody">
        <div class="row two">
          <div class="field">
            <div class="label"><span>Vehicle ID</span><span>Auto if empty</span></div>
            <input id="vId" class="input" placeholder="VEH-123ABC" />
          </div>
          <div class="field">
            <div class="label"><span>Status</span><span>Controls visibility</span></div>
            <select id="vStatus" class="select">
              <option value="published">Published (shows on storefront)</option>
              <option value="available">Available</option>
              <option value="pending">Pending</option>
              <option value="sold">Sold</option>
            </select>
          </div>
        </div>

        <div class="row two">
          <div class="field">
            <div class="label"><span>Make</span><span>Required</span></div>
            <input id="vMake" class="input" placeholder="Toyota" list="makeList" />
            <datalist id="makeList">
              <option>Toyota</option><option>Honda</option><option>Nissan</option><option>Mazda</option>
              <option>Suzuki</option><option>Mitsubishi</option><option>Subaru</option><option>BMW</option>
              <option>Mercedes-Benz</option><option>Audi</option><option>Kia</option><option>Hyundai</option>
              <option>Volkswagen</option><option>Ford</option><option>Chevrolet</option>
            </datalist>
          </div>
          <div class="field">
            <div class="label"><span>Model</span><span>Required</span></div>
            <input id="vModel" class="input" placeholder="Vitz" />
          </div>
        </div>

        <div class="row three">
          <div class="field">
            <div class="label"><span>Year</span><span>Optional</span></div>
            <input id="vYear" class="input" type="number" min="1980" max="2100" placeholder="2018" />
          </div>
          <div class="field">
            <div class="label"><span>Price (JMD)</span><span>Optional</span></div>
            <input id="vPrice" class="input" type="number" min="0" step="1000" placeholder="1250000" />
          </div>
          <div class="field">
            <div class="label"><span>Title</span><span>Optional</span></div>
            <input id="vTitle" class="input" placeholder="2018 Toyota Vitz — Clean unit" />
          </div>
        </div>

        <div class="row three">
          <div class="field">
            <div class="label"><span>Transmission</span><span>Optional</span></div>
            <select id="vTrans" class="select">
              <option value="">—</option>
              <option>Automatic</option>
              <option>Manual</option>
              <option>CVT</option>
              <option>DCT</option>
            </select>
          </div>
          <div class="field">
            <div class="label"><span>Fuel</span><span>Optional</span></div>
            <select id="vFuel" class="select">
              <option value="">—</option>
              <option>Gasoline</option>
              <option>Diesel</option>
              <option>Hybrid</option>
              <option>Electric</option>
            </select>
          </div>
          <div class="field">
            <div class="label"><span>Body type</span><span>Optional</span></div>
            <select id="vBody" class="select">
              <option value="">—</option>
              <option>Sedan</option>
              <option>Hatchback</option>
              <option>SUV</option>
              <option>Wagon</option>
              <option>Pickup</option>
              <option>Van</option>
              <option>Coupe</option>
            </select>
          </div>
        </div>

        <div class="row two">
          <div class="field">
            <div class="label"><span>Color</span><span>Optional</span></div>
            <select id="vColor" class="select">
              <option value="">—</option>
              <option>White</option><option>Black</option><option>Silver</option><option>Grey</option>
              <option>Blue</option><option>Red</option><option>Green</option><option>Brown</option>
              <option>Beige</option><option>Other</option>
            </select>
          </div>
          <div class="field">
            <div class="label"><span>Location</span><span>Optional</span></div>
            <select id="vLoc" class="select">
              <option value="">—</option>
              <option>Kingston</option><option>St. Andrew</option><option>St. Catherine</option>
              <option>Montego Bay</option><option>St. James</option><option>Ocho Rios</option>
              <option>Portmore</option><option>May Pen</option><option>Mandeville</option>
              <option>Other</option>
            </select>
          </div>
        </div>

        <div class="field">
          <div class="label"><span>Notes</span><span>Shown to customers</span></div>
          <textarea id="vNotes" class="textarea" placeholder="Example: clean unit, trade-in welcome, financing available, contact for video walk-through."></textarea>
        </div>

        <div class="uploadBox">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap">
            <div>
              <div style="font-weight:900; font-size:13px">Photos</div>
              <div class="hint">Select images — we upload using signed URLs (fast, reliable).</div>
            </div>
            <div class="chip" id="uploadState">Not uploaded</div>
          </div>

          <div class="field">
            <div class="label"><span>Choose files</span><span>Images</span></div>
            <input id="files" class="input" type="file" multiple accept="image/*" />
          </div>

          <div class="preview" id="preview"></div>
          <div class="hint" id="uploadHint" style="margin-top:8px">After saving, we’ll upload photos automatically.</div>
        </div>

        <div style="display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap; margin-top:12px">
          <button class="btn btn-ghost" id="btnCancel" type="button">Cancel</button>
          <button class="btn btn-primary" id="btnSave" type="button">Save vehicle</button>
        </div>

        <div class="statusline" id="mStatusLine"></div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast">
    <div id="toastDot"></div>
    <div id="toastMsg"></div>
  </div>

  <script>
    /**
     * NEW BACKEND (your server.js)
     * POST /api/dealer/login             { dealerId, passcode } -> { ok:true, token, dealerName, dealerId }
     * GET  /api/dealer/vehicles          (auth) -> { ok:true, vehicles:[...] }
     * POST /api/dealer/vehicles          (auth) -> { ok:true, vehicle }
     * POST /api/dealer/uploads/sign      (auth) -> { ok:true, url, publicUrl, objectKey }
     *
     * Upload flow:
     * 1) save vehicle row (creates vehicleId if empty)
     * 2) for each file: sign -> PUT to signed URL -> collect publicUrl
     * 3) update vehicle row again with images + heroImage
     */

    const API = {
      login: () => "/api/dealer/login",
      vehicles: () => "/api/dealer/vehicles",
      createVehicle: () => "/api/dealer/vehicles",
      signUpload: () => "/api/dealer/uploads/sign",
    };

    const el = (id) => document.getElementById(id);

    const ui = {
      // views
      loginTop: el("loginTop"),
      dashTop: el("dashTop"),
      loginView: el("loginView"),
      dashView: el("dashView"),

      // login
      dealerId: el("dealerId"),
      passcode: el("passcode"),
      btnLogin: el("btnLogin"),
      btnDemo: el("btnDemo"),
      loginStatus: el("loginStatus"),

      // header
      dealerTitle: el("dealerTitle"),
      dealerSub: el("dealerSub"),
      apiDot: el("apiDot"),
      apiStatus: el("apiStatus"),
      btnRefresh: el("btnRefresh"),
      btnAdd: el("btnAdd"),
      btnLogout: el("btnLogout"),

      // filters
      q: el("q"),
      filterStatus: el("filterStatus"),
      sort: el("sort"),
      dashStatus: el("dashStatus"),
      lastUpdated: el("lastUpdated"),
      count: el("count"),
      tbody: el("tbody"),

      // modal
      backdrop: el("backdrop"),
      mClose: el("mClose"),
      btnCancel: el("btnCancel"),
      btnSave: el("btnSave"),
      mTitle: el("mTitle"),
      mSub: el("mSub"),
      mStatusLine: el("mStatusLine"),

      vId: el("vId"),
      vStatus: el("vStatus"),
      vMake: el("vMake"),
      vModel: el("vModel"),
      vYear: el("vYear"),
      vPrice: el("vPrice"),
      vTitle: el("vTitle"),
      vTrans: el("vTrans"),
      vFuel: el("vFuel"),
      vBody: el("vBody"),
      vColor: el("vColor"),
      vLoc: el("vLoc"),
      vNotes: el("vNotes"),

      files: el("files"),
      preview: el("preview"),
      uploadHint: el("uploadHint"),
      uploadState: el("uploadState"),

      // toast
      toast: el("toast"),
      toastDot: el("toastDot"),
      toastMsg: el("toastMsg"),
    };

    const state = {
      token: null,
      dealerId: null,
      dealerName: null,
      apiOnline: false,
      vehicles: [],
      editing: null
    };

    document.addEventListener("DOMContentLoaded", () => {
      wire();
      ui.dealerId.focus();
    });

    function wire(){
      ui.btnLogin.addEventListener("click", doLogin);
      ui.btnDemo.addEventListener("click", enterDemo);
      ui.passcode.addEventListener("keydown", (e) => { if(e.key === "Enter") doLogin(); });

      ui.btnLogout.addEventListener("click", logout);
      ui.btnRefresh.addEventListener("click", loadVehicles);
      ui.btnAdd.addEventListener("click", () => openModal());

      ui.q.addEventListener("keydown", (e) => { if(e.key === "Enter") render(); });
      ui.filterStatus.addEventListener("change", render);
      ui.sort.addEventListener("change", render);

      ui.mClose.addEventListener("click", closeModal);
      ui.btnCancel.addEventListener("click", closeModal);
      ui.backdrop.addEventListener("click", (e) => { if(e.target === ui.backdrop) closeModal(); });

      ui.btnSave.addEventListener("click", saveVehicle);

      ui.files.addEventListener("change", renderPreview);
    }

    async function doLogin(){
      const dealerId = (ui.dealerId.value || "").trim();
      const passcode = (ui.passcode.value || "").trim();
      if(!dealerId || !passcode){
        setLoginStatus("Enter Dealer ID and passcode.", true);
        return;
      }
      setLoginStatus("Signing in…", false);

      try{
        const res = await fetch(API.login(), {
          method:"POST",
          headers:{ "Content-Type":"application/json", "Accept":"application/json" },
          body: JSON.stringify({ dealerId, passcode })
        });

        const data = await safeJson(res);
        if(!res.ok || !data || data.ok !== true){
          throw new Error(data?.error || "Login failed");
        }

        state.apiOnline = true;
        state.token = data.token;
        state.dealerId = data.dealerId || dealerId;
        state.dealerName = data.dealerName || dealerId;

        setApi("Live", "on");
        enterDashboard();
      }catch(e){
        setLoginStatus(e?.message || "Login failed. Check credentials.", true);
        setApi("Error", "err");
      }
    }

    function enterDemo(){
      state.apiOnline = false;
      state.token = "demo-token";
      state.dealerId = "DEALER-DEMO";
      state.dealerName = "Demo Dealer";
      state.vehicles = demoVehicles();
      setApi("Demo", "off");
      enterDashboard();
      render();
      toast("Demo mode loaded.", "success");
    }

    function enterDashboard(){
      ui.loginTop.classList.add("hidden");
      ui.loginView.classList.add("hidden");

      ui.dashTop.classList.remove("hidden");
      ui.dashView.classList.remove("hidden");

      ui.dealerTitle.textContent = state.dealerName || "Dealer";
      ui.dealerSub.textContent = `${state.dealerId || ""} · inventory manager`;
      loadVehicles();
    }

    function logout(){
      state.token = null;
      state.dealerId = null;
      state.dealerName = null;
      state.vehicles = [];
      state.apiOnline = false;

      ui.dashTop.classList.add("hidden");
      ui.dashView.classList.add("hidden");

      ui.loginTop.classList.remove("hidden");
      ui.loginView.classList.remove("hidden");
      ui.loginStatus.textContent = "";
      setApi("—", "off");
      toast("Logged out.", "success");
    }

    async function loadVehicles(){
      ui.dashStatus.textContent = "Loading vehicles…";
      if(!state.apiOnline){
        ui.dashStatus.textContent = "Demo inventory loaded.";
        ui.lastUpdated.textContent = "Updated: " + fmt(new Date());
        render();
        return;
      }

      try{
        const res = await fetch(API.vehicles(), {
          headers:{
            "Accept":"application/json",
            "Authorization":"Bearer " + state.token
          }
        });

        const data = await safeJson(res);
        if(!res.ok || !data || data.ok !== true || !Array.isArray(data.vehicles)){
          throw new Error(data?.error || "Failed to load vehicles");
        }

        state.vehicles = normalize(data.vehicles);

        ui.dashStatus.textContent = "Ready.";
        ui.lastUpdated.textContent = "Updated: " + fmt(new Date());
        setApi("Live", "on");
        render();
      }catch(e){
        ui.dashStatus.textContent = "Could not load vehicles.";
        setApi("Error", "err");
        toast(e?.message || "Failed to load inventory.", "error");
      }
    }

    function render(){
      const q = (ui.q.value || "").trim().toLowerCase();
      const fs = (ui.filterStatus.value || "").toLowerCase();
      const sort = ui.sort.value || "newest";

      let list = [...state.vehicles];

      if(q) list = list.filter(v => blob(v).includes(q));
      if(fs) list = list.filter(v => (String(v.status||"").toLowerCase() === fs));

      list.sort((a,b)=>{
        if(sort==="priceAsc") return (a.price||0)-(b.price||0);
        if(sort==="priceDesc") return (b.price||0)-(a.price||0);
        if(sort==="yearAsc") return (a.year||0)-(b.year||0);
        if(sort==="yearDesc") return (b.year||0)-(a.year||0);
        return new Date(b.updatedAt||b.createdAt||0).getTime() - new Date(a.updatedAt||a.createdAt||0).getTime();
      });

      ui.tbody.innerHTML = "";
      ui.count.textContent = String(list.length);

      if(!list.length){
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5;
        td.style.color = "var(--muted)";
        td.style.padding = "14px";
        td.textContent = "No vehicles match your filters.";
        tr.appendChild(td);
        ui.tbody.appendChild(tr);
        return;
      }

      list.forEach(v => {
        const tr = document.createElement("tr");
        tr.style.cursor = "pointer";
        tr.addEventListener("click", () => openModal(v));

        const title = esc(v.title || `${v.year||""} ${v.make||""} ${v.model||""}`.trim() || "Vehicle");
        const spec1 = `${esc(v.year ? String(v.year) : "—")} · ${esc(v.bodyType||"—")}`;
        const spec2 = `${esc(v.transmission||"—")} · ${esc(v.fuel||"—")}`;

        const td1 = document.createElement("td");
        td1.innerHTML = `<div style="font-weight:900">${title}</div>
                         <div class="mono" style="color:var(--muted);margin-top:3px">${esc(v.vehicleId)}</div>`;

        const td2 = document.createElement("td");
        td2.innerHTML = `<div>${spec1}</div>
                         <div style="color:var(--muted);font-size:11px;margin-top:2px">${spec2}</div>`;

        const td3 = document.createElement("td");
        const s = (v.status||"available").toLowerCase();
        td3.innerHTML = `<span class="status ${esc(s)}">${esc(s)}</span>`;

        const td4 = document.createElement("td");
        td4.innerHTML = `<div style="font-weight:900">${money(v.price)}</div>
                         <div style="color:var(--muted);font-size:11px;margin-top:2px">${esc(v.location||"")}</div>`;

        const td5 = document.createElement("td");
        const count = (v.images||[]).length;
        td5.innerHTML = `<span class="chip">${count} photo${count===1?"":"s"}</span>`;

        tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4); tr.appendChild(td5);
        ui.tbody.appendChild(tr);
      });
    }

    function openModal(v=null){
      state.editing = v ? {...v} : null;

      ui.mTitle.textContent = v ? "Edit vehicle" : "Add vehicle";
      ui.mSub.textContent = v ? "Update details, then upload photos if needed." : "Add details, then upload photos in one save.";
      ui.mStatusLine.textContent = "";
      ui.mStatusLine.classList.remove("error");

      ui.vId.value = v?.vehicleId || "";
      ui.vStatus.value = (v?.status || "published").toLowerCase();
      ui.vMake.value = v?.make || "";
      ui.vModel.value = v?.model || "";
      ui.vYear.value = v?.year || "";
      ui.vPrice.value = v?.price || "";
      ui.vTitle.value = v?.title || "";
      ui.vTrans.value = v?.transmission || "";
      ui.vFuel.value = v?.fuel || "";
      ui.vBody.value = v?.bodyType || "";
      ui.vColor.value = v?.color || "";
      ui.vLoc.value = v?.location || "";
      ui.vNotes.value = v?.notes || "";

      ui.files.value = "";
      ui.preview.innerHTML = "";
      ui.uploadHint.textContent = "After saving, we’ll upload photos automatically.";
      ui.uploadState.textContent = "Not uploaded";

      ui.backdrop.classList.add("show");
      ui.backdrop.setAttribute("aria-hidden","false");
    }

    function closeModal(){
      ui.backdrop.classList.remove("show");
      ui.backdrop.setAttribute("aria-hidden","true");
      state.editing = null;
    }

    function renderPreview(){
      ui.preview.innerHTML = "";
      const files = ui.files.files ? Array.from(ui.files.files) : [];
      if(!files.length){
        ui.uploadState.textContent = "Not uploaded";
        return;
      }
      ui.uploadState.textContent = `${files.length} selected`;
      files.slice(0, 12).forEach(f=>{
        const div = document.createElement("div");
        div.className = "thumb";
        const img = document.createElement("img");
        img.alt = f.name;
        img.src = URL.createObjectURL(f);
        div.appendChild(img);
        ui.preview.appendChild(div);
      });
      if(files.length > 12){
        const div = document.createElement("div");
        div.className = "thumb";
        div.textContent = `+${files.length-12}`;
        ui.preview.appendChild(div);
      }
    }

    async function saveVehicle(){
      const payload = {
        vehicleId: (ui.vId.value || "").trim() || genVehicleId(),
        status: (ui.vStatus.value || "published").toLowerCase(),
        make: (ui.vMake.value || "").trim(),
        model: (ui.vModel.value || "").trim(),
        year: toYear(ui.vYear.value),
        price: toNum(ui.vPrice.value),
        title: (ui.vTitle.value || "").trim(),
        transmission: (ui.vTrans.value || "").trim(),
        fuel: (ui.vFuel.value || "").trim(),
        bodyType: (ui.vBody.value || "").trim(),
        color: (ui.vColor.value || "").trim(),
        location: (ui.vLoc.value || "").trim(),
        notes: (ui.vNotes.value || "").trim(),
      };

      if(!payload.make || !payload.model){
        setMStatus("Make and Model are required.", true);
        return;
      }

      setMStatus("Saving vehicle…", false);
      ui.btnSave.disabled = true;

      try{
        let saved = payload;

        if(state.apiOnline){
          // Save vehicle row first
          const res = await fetch(API.createVehicle(), {
            method:"POST",
            headers:{
              "Content-Type":"application/json",
              "Accept":"application/json",
              "Authorization":"Bearer " + state.token
            },
            body: JSON.stringify(payload)
          });

          const data = await safeJson(res);
          if(!res.ok || !data || data.ok !== true){
            throw new Error(data?.error || "Save failed");
          }

          saved = normalize([data.vehicle || payload])[0];
        } else {
          // demo mode local
          const idx = state.vehicles.findIndex(x => x.vehicleId === payload.vehicleId);
          const merged = {
            ...(idx>-1?state.vehicles[idx]:{}),
            ...payload,
            images:(idx>-1?state.vehicles[idx].images:[])||[],
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          };
          if(idx>-1) state.vehicles[idx] = merged; else state.vehicles.unshift(merged);
          saved = merged;
        }

        // Upload selected files (SIGNED URL FLOW)
        const files = ui.files.files ? Array.from(ui.files.files) : [];
        if (files.length && state.apiOnline){
          setMStatus("Uploading photos…", false);
          ui.uploadHint.textContent = "Uploading… keep this tab open.";

          const uploadedUrls = [];

          for (const f of files){
            // 1) Sign
            const signRes = await fetch(API.signUpload(), {
              method:"POST",
              headers:{
                "Content-Type":"application/json",
                "Accept":"application/json",
                "Authorization":"Bearer " + state.token
              },
              body: JSON.stringify({
                vehicleId: saved.vehicleId,
                type: "image",
                filename: f.name,
                contentType: f.type || "application/octet-stream"
              })
            });

            const signData = await safeJson(signRes);
            if(!signRes.ok || !signData || signData.ok !== true || !signData.url){
              throw new Error(signData?.error || "Sign upload failed");
            }

            // 2) PUT to GCS
            const putRes = await fetch(signData.url, {
              method:"PUT",
              headers:{ "Content-Type": f.type || "application/octet-stream" },
              body: f
            });

            if(!putRes.ok){
              const t = await putRes.text().catch(()=> "");
              throw new Error("Upload failed: " + (t || "PUT error"));
            }

            uploadedUrls.push(signData.publicUrl);
          }

          // 3) Update vehicle with images + heroImage
          const mergedImages = uniq([...(saved.images||[]), ...uploadedUrls]);
          const hero = saved.heroImage || uploadedUrls[0] || "";

          const updateRes = await fetch(API.createVehicle(), {
            method:"POST",
            headers:{
              "Content-Type":"application/json",
              "Accept":"application/json",
              "Authorization":"Bearer " + state.token
            },
            body: JSON.stringify({
              ...saved,
              images: mergedImages,
              heroImage: hero
            })
          });

          const updateData = await safeJson(updateRes);
          if(!updateRes.ok || !updateData || updateData.ok !== true){
            throw new Error(updateData?.error || "Final save failed");
          }

          ui.uploadState.textContent = "Uploaded";
          ui.uploadHint.textContent = "Uploaded ✔ Photos are now attached to this vehicle.";
          toast("Vehicle saved + photos uploaded.", "success");
        } else {
          if(files.length && !state.apiOnline){
            toast("Demo mode: uploads disabled.", "error");
          } else {
            toast("Vehicle saved.", "success");
          }
        }

        await loadVehicles();
        closeModal();
      }catch(e){
        setMStatus(e?.message || "Save failed.", true);
        toast(e?.message || "Save failed.", "error");
      }finally{
        ui.btnSave.disabled = false;
      }
    }

    function setLoginStatus(msg, err){
      ui.loginStatus.textContent = msg || "";
      ui.loginStatus.classList.toggle("error", !!err);
    }
    function setMStatus(msg, err){
      ui.mStatusLine.textContent = msg || "";
      ui.mStatusLine.classList.toggle("error", !!err);
    }

    function setApi(text, mode){
      ui.apiStatus.textContent = text || "—";
      ui.apiDot.classList.remove("on","err");
      if(mode==="on") ui.apiDot.classList.add("on");
      if(mode==="err") ui.apiDot.classList.add("err");
    }

    function toast(message, type){
      ui.toastMsg.textContent = message || "";
      ui.toast.classList.remove("success","error");
      if(type==="success"){ ui.toast.classList.add("success"); ui.toastDot.style.background="#16a34a"; }
      else if(type==="error"){ ui.toast.classList.add("error"); ui.toastDot.style.background="#ef4444"; }
      else ui.toastDot.style.background="var(--red)";
      ui.toast.classList.add("show");
      clearTimeout(window.__t);
      window.__t = setTimeout(()=>ui.toast.classList.remove("show"), 3200);
    }

    function normalize(list){
      return (list||[]).map(v => ({
        vehicleId: v.vehicleId || v.id || genVehicleId(),
        dealerId: v.dealerId || state.dealerId || "",
        title: v.title || "",
        make: v.make || "",
        model: v.model || "",
        year: toYear(v.year),
        price: toNum(v.price),
        currency: v.currency || "JMD",
        status: (v.status || "available").toLowerCase(),
        transmission: v.transmission || "",
        fuel: v.fuel || "",
        bodyType: v.bodyType || v.type || "",
        color: v.color || "",
        location: v.location || "",
        notes: v.notes || "",
        heroImage: v.heroImage || "",
        images: Array.isArray(v.images) ? v.images : [],
        createdAt: v.createdAt || new Date().toISOString(),
        updatedAt: v.updatedAt || v.createdAt || new Date().toISOString()
      }));
    }

    function demoVehicles(){
      return normalize([
        { vehicleId:"VEH-10021", make:"Toyota", model:"Vitz", year:2018, price:1250000, status:"published", bodyType:"Hatchback", transmission:"Automatic", fuel:"Gasoline", color:"Silver", location:"Kingston", notes:"Clean unit. Video viewing available.", images:["x","y"], createdAt: new Date(Date.now()-86400000*2).toISOString() },
        { vehicleId:"VEH-10022", make:"Honda", model:"Civic", year:2017, price:2200000, status:"pending", bodyType:"Sedan", transmission:"Automatic", fuel:"Gasoline", color:"Blue", location:"St. Andrew", notes:"Pending deposit.", images:["x"], createdAt: new Date(Date.now()-86400000*6).toISOString() },
        { vehicleId:"VEH-10023", make:"BMW", model:"3 Series", year:2016, price:3950000, status:"available", bodyType:"Sedan", transmission:"Automatic", fuel:"Gasoline", color:"Black", location:"Montego Bay", notes:"Premium interior.", images:["x","y","z"], createdAt: new Date(Date.now()-86400000*1).toISOString() },
      ]);
    }

    function blob(v){
      return [
        v.vehicleId, v.title, v.make, v.model, v.year, v.bodyType,
        v.transmission, v.fuel, v.color, v.location, v.notes, v.status
      ].filter(Boolean).join(" ").toLowerCase();
    }

    function money(n){
      n = toNum(n);
      if(!n) return "Price on request";
      return "JMD " + n.toLocaleString(undefined,{maximumFractionDigits:0});
    }

    function fmt(d){
      const dt = (d instanceof Date)?d:new Date(d);
      const day = String(dt.getDate()).padStart(2,"0");
      const mon = String(dt.getMonth()+1).padStart(2,"0");
      const yr = String(dt.getFullYear()).slice(-2);
      const hr = String(dt.getHours()).padStart(2,"0");
      const mi = String(dt.getMinutes()).padStart(2,"0");
      return `${day}/${mon}/${yr} ${hr}:${mi}`;
    }

    function toNum(v){
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }

    function toYear(v){
      const n = Number(v);
      if(!Number.isFinite(n) || n <= 0) return 0;
      return Math.max(1980, Math.min(2100, Math.floor(n)));
    }

    function genVehicleId(){
      return "VEH-" + Math.random().toString(16).slice(2,8).toUpperCase();
    }

    function uniq(arr){
      const out = [];
      const s = new Set();
      (arr||[]).forEach(x=>{
        const v = String(x||"").trim();
        if(!v) return;
        if(s.has(v)) return;
        s.add(v);
        out.push(v);
      });
      return out;
    }

    async function safeJson(res){
      try{ return await res.json(); }
      catch{ return null; }
    }

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }
  </script>
</body>
</html>
